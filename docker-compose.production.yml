version: '3.8'

# Production network connection - connects to live QuantumHarmony validators
# Usage: docker-compose -f docker-compose.production.yml up
#
# PQC Transport Migration:
#   After the PQC transport upgrade, all validators will generate new PeerIds
#   derived from Falcon-1024 public keys (replacing Ed25519-derived PeerIds).
#
#   Deployment steps:
#   1. Build updated binary with pqc-transport feature (enabled by default)
#   2. Stop all validators simultaneously
#   3. Start each validator â€” it will generate pqc_transport_identity.json on first run
#   4. Record new PQC PeerIds from startup logs:
#        ðŸ”‘ [PQC-TRANSPORT] PeerId: 12D3KooW...
#   5. Update bootnodes below with new PeerIds
#   6. Rebuild chain spec with new PeerIds if needed
#
#   Current bootnodes (classical Ed25519 â€” will change after PQC migration):
#     Bob:     12D3KooWHdiAxVd8uMQR1hGWXccidmfCwLqcMpGwR6QcTP6QRMuD
#     Charlie: 12D3KooWSCufgHzV4fCwRijfH2k3abrpAJxTKxEvN1FDuRXA2U9x
#     Alice:   12D3KooWDmLjhsvwEh3Xdat6daVhRm87ed88J9Sx4ti44osaDM8W

services:
  quantumharmony:
    image: quantumharmony:latest
    build:
      context: ..
      dockerfile: quantumharmony/Dockerfile.multinode
    container_name: quantumharmony-fullnode
    hostname: fullnode
    ports:
      - "9944:9944"
      - "30333:30333"
    volumes:
      - fullnode-data:/data
      - ./chainspec-production.json:/chainspec/chainspec-production.json:ro
    command: >
      --chain=/chainspec/chainspec-production.json
      --base-path=/data
      --name=docker-fullnode
      --unsafe-rpc-external
      --rpc-cors=all
      --rpc-methods=safe
      --port=30333
      --rpc-port=9944
      --bootnodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWHdiAxVd8uMQR1hGWXccidmfCwLqcMpGwR6QcTP6QRMuD
      --bootnodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWSCufgHzV4fCwRijfH2k3abrpAJxTKxEvN1FDuRXA2U9x
      --bootnodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWDmLjhsvwEh3Xdat6daVhRm87ed88J9Sx4ti44osaDM8W
    environment:
      - RUST_LOG=info,sync=debug
      # Uncomment to inject a pre-generated PQC identity:
      # - PQC_IDENTITY_KEY={"falcon_public_key":"0x...","falcon_secret_key":"0x..."}
    restart: unless-stopped
    # Uncomment to use Docker secrets for PQC identity:
    # secrets:
    #   - pqc_identity_key

volumes:
  fullnode-data:

# Uncomment to define Docker secrets:
# secrets:
#   pqc_identity_key:
#     file: ./secrets/pqc_identity_key.json

networks:
  default:
    driver: bridge
