# QuantumHarmony Node Operator v1.1
# One-command deployment for node operators
# Includes: blockchain node, messaging service, and dashboard
# Updated: January 2026 - Fixed cache/CORS, env-based bootnodes

services:
  # =====================================================
  # CORE: QuantumHarmony Blockchain Node
  # =====================================================
  node:
    image: sylvaincormier/quantumharmony-node:arm64
    # platform: linux/amd64  # Using native arm64 on Apple Silicon
    container_name: quantumharmony-node
    restart: unless-stopped
    ports:
      - "9944:9944"   # RPC/WebSocket
      - "30333:30333" # P2P
      - "9615:9615"   # Prometheus metrics
    volumes:
      - node-data:/data
      - ./configs/chain-spec.json:/config/chainspec.json:ro
    command:
      - "--chain=/config/chainspec.json"
      - "--sync=full"
      - "--base-path=/data"
      - "--name=${NODE_NAME:-Operator}"
      - "--rpc-external"
      - "--rpc-cors=all"
      - "--rpc-methods=Unsafe"
      - "--bootnodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWLmphH9JtAVntVnZ4fZ5keJSjKEyWFANcKVzWVLnwVe9Z"
      - "--bootnodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWGiDT7jsuqFJhsvoN4KZp8KZ5CjtUnEvRxUNVNvLRwnFA"
      - "--bootnodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWRzTbwny8fUNUZQvS24RJWj44RSivgCQNN6Bb6WwhTQNh"
    environment:
      - NODE_NAME=${NODE_NAME:-Operator}
      - VALIDATOR=${VALIDATOR:-true}
      - RPC_METHODS=${RPC_METHODS:-Unsafe}
      - BOOTNODES=${BOOTNODES:-/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWLmphH9JtAVntVnZ4fZ5keJSjKEyWFANcKVzWVLnwVe9Z,/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWGiDT7jsuqFJhsvoN4KZp8KZ5CjtUnEvRxUNVNvLRwnFA,/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWRzTbwny8fUNUZQvS24RJWj44RSivgCQNN6Bb6WwhTQNh}
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =====================================================
  # MESSAGING: Node Operator Service (VOTE SYNC)
  # Post-quantum encrypted validator messaging
  # =====================================================
  operator:
    image: sylvaincormier/quantumharmony-node-operator:latest
    platform: linux/amd64
    container_name: quantumharmony-operator
    restart: unless-stopped
    ports:
      - "9955:9955"   # Operator API + VOTE SYNC messaging
    volumes:
      - operator-data:/data
    environment:
      - OPERATOR_PORT=9955
      - DATA_DIR=/data
      - RPC_URL=http://node:9944
      - ALLOW_UNAUTHENTICATED=true
    networks:
      - quantum-net
    depends_on:
      - node
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9955/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =====================================================
  # DASHBOARD: Operator Web UI with VOTE SYNC
  # =====================================================
  dashboard:
    image: nginx:alpine
    container_name: quantumharmony-dashboard
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./configs/nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - quantum-net
    depends_on:
      - node
      - operator

  # =====================================================
  # AUTO-UPDATER: Sidecar that polls Docker Hub for
  # new image digests and performs rolling updates
  # =====================================================
  updater:
    build: ./updater
    container_name: quantumharmony-updater
    restart: unless-stopped
    environment:
      - IMAGE=sylvaincormier/quantumharmony-node
      - IMAGE_TAG=arm64
      - UPDATE_INTERVAL=86400
      - MONITOR_INTERVAL=60
      - HEALTH_TIMEOUT=180
      - HEALTH_URL=http://node:9944/health
      - COMPOSE_PROJECT=node-operator-dashboard
      - NODE_CONTAINER=quantumharmony-node
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker-compose.yml:/compose/docker-compose.yml:ro
    networks:
      - quantum-net
    depends_on:
      - node

networks:
  quantum-net:
    driver: bridge

volumes:
  node-data:
  operator-data:
