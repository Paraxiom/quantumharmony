# QuantumHarmony Node Operator
# One-command deployment for node operators
# Includes: blockchain node, messaging service, and dashboard

services:
  # =====================================================
  # CORE: QuantumHarmony Blockchain Node
  # =====================================================
  node:
    image: sylvaincormier/quantumharmony-node:latest
    platform: linux/amd64
    container_name: quantumharmony-node
    restart: unless-stopped
    ports:
      - "9944:9944"   # RPC/WebSocket
      - "30333:30333" # P2P
      - "9615:9615"   # Prometheus metrics
    volumes:
      - node-data:/data
      - ./configs/chain-spec.json:/config/chainspec.json:ro
    command:
      - "--chain=/config/chainspec.json"
      - "--base-path=/data"
      - "--name=${NODE_NAME:-Operator}"
      - "--validator"
      - "--rpc-external"
      - "--rpc-cors=all"
      - "--rpc-methods=Unsafe"
      - "--network-backend=libp2p"
      - "--pool-type=single-state"
      - "--bootnodes=/ip4/51.79.26.123/tcp/30333/p2p/12D3KooWDmLjhsvwEh3Xdat6daVhRm87ed88J9Sx4ti44osaDM8W"
      - "--bootnodes=/ip4/51.79.26.168/tcp/30333/p2p/12D3KooWDQp7gSEEHgpGpvnui67v8s3PQ6RvYpocu96WvyuYwak1"
      - "--bootnodes=/ip4/209.38.225.4/tcp/30333/p2p/12D3KooWPA9JZqTaDokCDToirUuA6DcfPuc2QN9DSzaJvMe3Yvcy"
    environment:
      - NODE_NAME=${NODE_NAME:-Operator}
    networks:
      - quantum-net
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9944/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =====================================================
  # MESSAGING: Node Operator Service (VOTE SYNC)
  # Post-quantum encrypted validator messaging
  # =====================================================
  operator:
    image: sylvaincormier/quantumharmony-node-operator:latest
    platform: linux/amd64
    container_name: quantumharmony-operator
    restart: unless-stopped
    ports:
      - "9955:9955"   # Operator API + VOTE SYNC messaging
    volumes:
      - operator-data:/data
    environment:
      - OPERATOR_PORT=9955
      - DATA_DIR=/data
      - RPC_URL=http://node:9944
      - ALLOW_UNAUTHENTICATED=true
    networks:
      - quantum-net
    depends_on:
      - node
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9955/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # =====================================================
  # DASHBOARD: Operator Web UI with VOTE SYNC
  # =====================================================
  dashboard:
    image: nginx:alpine
    container_name: quantumharmony-dashboard
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./configs/nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - quantum-net
    depends_on:
      - node
      - operator

networks:
  quantum-net:
    driver: bridge

volumes:
  node-data:
  operator-data:
