version: '3.8'

# QuantumHarmony Local 3-Validator Testnet
#
# PQC Transport (Kyber-1024 + Falcon-1024):
#   All P2P connections use post-quantum cryptographic transport by default
#   (pqc-transport feature is enabled in the build). PQC identities are
#   auto-generated on first run and persisted in each node's data volume.
#
#   NOTE: The bootnodes below use classical Ed25519-derived PeerIds (from --node-key).
#   With PQC transport, authenticated PeerIds differ (Falcon-1024 derived), but mDNS
#   peer discovery on the docker network handles connections regardless.
#
#   To inject pre-generated PQC identities for stable PQC PeerIds:
#     PQC_IDENTITY_KEY: '{"falcon_public_key":"0x...","falcon_secret_key":"0x..."}'

services:
  alice:
    image: quantumharmony:latest
    build:
      context: ..
      dockerfile: quantumharmony/Dockerfile.multinode
    container_name: quantumharmony-alice
    hostname: alice
    ports:
      - "9944:9944"
      - "30333:30333"
    volumes:
      - alice-data:/data
    command: >
      --chain=local
      --alice
      --validator
      --base-path=/data
      --unsafe-rpc-external
      --rpc-cors=all
      --rpc-methods=safe
      --unsafe-ws-external
      --port=30333
      --rpc-port=9944
      --node-key=0000000000000000000000000000000000000000000000000000000000000001
    networks:
      quantum-net:
        ipv4_address: 172.20.0.10
    environment:
      - RUST_LOG=info,coherence=debug

  bob:
    image: quantumharmony:latest
    build:
      context: ..
      dockerfile: quantumharmony/Dockerfile.multinode
    container_name: quantumharmony-bob
    hostname: bob
    ports:
      - "9945:9944"
      - "30334:30333"
    volumes:
      - bob-data:/data
    command: >
      --chain=local
      --bob
      --validator
      --base-path=/data
      --unsafe-rpc-external
      --rpc-cors=all
      --rpc-methods=safe
      --unsafe-ws-external
      --port=30333
      --rpc-port=9944
      --node-key=0000000000000000000000000000000000000000000000000000000000000002
      --bootnodes=/ip4/172.20.0.10/tcp/30333/p2p/12D3KooWNpaTf134DUqez17tRCLPwdgBeQGAwh7hV94iPnd1u37d
    networks:
      quantum-net:
        ipv4_address: 172.20.0.11
    environment:
      - RUST_LOG=info,coherence=debug
    depends_on:
      - alice

  charlie:
    image: quantumharmony:latest
    build:
      context: ..
      dockerfile: quantumharmony/Dockerfile.multinode
    container_name: quantumharmony-charlie
    hostname: charlie
    ports:
      - "9946:9944"
      - "30335:30333"
    volumes:
      - charlie-data:/data
    command: >
      --chain=local
      --charlie
      --validator
      --base-path=/data
      --unsafe-rpc-external
      --rpc-cors=all
      --rpc-methods=safe
      --unsafe-ws-external
      --port=30333
      --rpc-port=9944
      --node-key=0000000000000000000000000000000000000000000000000000000000000003
      --bootnodes=/ip4/172.20.0.10/tcp/30333/p2p/12D3KooWNpaTf134DUqez17tRCLPwdgBeQGAwh7hV94iPnd1u37d
    networks:
      quantum-net:
        ipv4_address: 172.20.0.12
    environment:
      - RUST_LOG=info,coherence=debug
    depends_on:
      - alice

volumes:
  alice-data:
  bob-data:
  charlie-data:

networks:
  quantum-net:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
