<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumHarmony Notarial Service</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --card-hover: #334155;
            --text: #f1f5f9;
            --muted: #94a3b8;
            --border: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 1.5rem; }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 2rem;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
        }
        .logo-text span { color: var(--muted); font-weight: 400; font-size: 0.9rem; }

        /* Account Button */
        .account-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }
        .account-btn:hover { background: var(--card-hover); }
        .account-btn.locked { border-color: var(--warning); }
        .account-btn.unlocked { border-color: var(--success); }
        .account-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        .account-btn.unlocked .account-indicator { background: var(--success); }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 0.25rem;
            background: var(--card);
            padding: 0.25rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .nav-tab {
            flex: 1;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            color: var(--muted);
            cursor: pointer;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .nav-tab:hover { color: var(--text); }
        .nav-tab.active { background: var(--primary); color: white; }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Cards */
        .card {
            background: var(--card);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Forms */
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--muted);
            margin-bottom: 0.5rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-hint {
            font-size: 0.75rem;
            color: var(--muted);
            margin-top: 0.25rem;
        }

        /* File Drop Zone */
        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 0.75rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }
        .drop-zone-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .drop-zone-text { color: var(--muted); }
        .drop-zone input[type="file"] { display: none; }

        /* File Info */
        .file-info {
            background: var(--bg);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            word-break: break-all;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--card-hover); color: var(--text); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-block { width: 100%; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }

        /* Grid */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 640px) { .grid-2 { grid-template-columns: 1fr; } }

        /* Status Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
        .badge-error { background: rgba(239, 68, 68, 0.2); color: var(--error); }
        .badge-info { background: rgba(99, 102, 241, 0.2); color: var(--primary); }

        /* Results */
        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: none;
        }
        .result.show { display: block; }
        .result.success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); }
        .result.error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); }
        .result.info { background: rgba(99, 102, 241, 0.1); border: 1px solid var(--primary); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: var(--card);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .modal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }

        /* Seed Phrase Display */
        .seed-phrase {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.8;
            word-spacing: 0.5rem;
        }
        .seed-phrase-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 1rem;
            font-size: 0.85rem;
            color: var(--warning);
        }

        /* Account List */
        .account-list { margin-top: 1rem; }
        .account-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .account-item.active { border: 1px solid var(--primary); }
        .account-item-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .account-item-name { font-weight: 500; }
        .account-item-address {
            font-size: 0.75rem;
            color: var(--muted);
            font-family: monospace;
        }
        .account-item-actions { display: flex; gap: 0.5rem; }

        /* Spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--muted);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Connection Status */
        .connection-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            background: var(--card);
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--warning);
        }
        .connection-dot.connected { background: var(--success); }

        /* Footer */
        footer {
            text-align: center;
            padding: 2rem 0;
            color: var(--muted);
            font-size: 0.8rem;
            border-top: 1px solid var(--border);
            margin-top: 2rem;
        }
        footer a { color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <div class="logo-icon">QH</div>
                <div class="logo-text">
                    Notarial<br>
                    <span>Post-Quantum Secure</span>
                </div>
            </div>
            <button class="account-btn locked" id="accountBtn" onclick="showAccountModal()">
                <span class="account-indicator"></span>
                <span id="accountBtnText">No Account</span>
            </button>
        </header>

        <!-- Connection Bar -->
        <div class="connection-bar">
            <div class="connection-status">
                <span class="connection-dot" id="connectionDot"></span>
                <span id="connectionText">Connecting...</span>
            </div>
            <div>
                <input type="text" id="rpcEndpoint" value="http://51.79.26.123:9944"
                    style="background: var(--bg); border: none; color: var(--text); font-size: 0.8rem; width: 200px; padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="attest">Attest</button>
            <button class="nav-tab" data-tab="verify">Verify</button>
            <button class="nav-tab" data-tab="contracts">Contracts</button>
            <button class="nav-tab" data-tab="fideicommis">Fideicommis</button>
            <button class="nav-tab" data-tab="qcad">QCAD</button>
            <button class="nav-tab" data-tab="account">Account</button>
            <button class="nav-tab" data-tab="settings">Settings</button>
        </div>

        <!-- Attest Panel -->
        <div class="panel active" id="panel-attest">
            <div class="card">
                <div class="card-title">
                    <span>Attest Document</span>
                    <span class="badge badge-info">SPHINCS+</span>
                </div>

                <div class="form-group">
                    <label class="form-label">Upload Document</label>
                    <div class="drop-zone" id="attestDropZone">
                        <div class="drop-zone-icon">üìÑ</div>
                        <div>Drop file here or click to upload</div>
                        <div class="drop-zone-text">Your document never leaves your browser</div>
                        <input type="file" id="attestFileInput">
                    </div>
                    <div class="file-info" id="attestFileInfo" style="display: none;"></div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="attestCategory">
                            <option value="0">Academic Credential</option>
                            <option value="1">Legal Document</option>
                            <option value="2">Contract</option>
                            <option value="3" selected>Intellectual Property</option>
                            <option value="4">Identity</option>
                            <option value="5">Financial</option>
                            <option value="6">Medical</option>
                            <option value="7">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validity</label>
                        <select class="form-select" id="attestValidity">
                            <option value="0" selected>Permanent</option>
                            <option value="14400">1 Day</option>
                            <option value="100800">1 Week</option>
                            <option value="432000">1 Month</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description (optional)</label>
                    <textarea class="form-textarea" id="attestDescription" placeholder="Brief description of the document..." maxlength="512"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Document Storage</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="storageOption" value="local" checked>
                            <span><strong>Local Only</strong> - Hash only, you keep the document</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="storageOption" value="ipfs-public">
                            <span><strong>IPFS Public</strong> - Document stored on IPFS (anyone with CID can access)</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="radio" name="storageOption" value="ipfs-encrypted">
                            <span><strong>IPFS Encrypted</strong> - Encrypted before upload (only you can decrypt)</span>
                        </label>
                    </div>
                    <div class="form-hint" id="ipfsConfigHint" style="display: none; color: var(--warning);">
                        IPFS requires Pinata API keys. <a href="#" onclick="showSettingsModal(); return false;" style="color: var(--primary);">Configure in Settings</a>
                    </div>
                </div>

                <button class="btn btn-primary btn-block" id="attestBtn" disabled>
                    Unlock Wallet to Sign
                </button>

                <div class="result" id="attestResult"></div>
            </div>
        </div>

        <!-- Verify Panel -->
        <div class="panel" id="panel-verify">
            <div class="card">
                <div class="card-title">Verify Document</div>

                <div class="form-group">
                    <label class="form-label">Upload Document to Verify</label>
                    <div class="drop-zone" id="verifyDropZone">
                        <div class="drop-zone-icon">üîç</div>
                        <div>Drop file here or click to upload</div>
                        <input type="file" id="verifyFileInput">
                    </div>
                    <div class="file-info" id="verifyFileInfo" style="display: none;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Or enter document hash</label>
                    <input type="text" class="form-input" id="verifyHash" placeholder="0x...">
                </div>

                <button class="btn btn-primary btn-block" id="verifyBtn">
                    Verify Document
                </button>

                <div class="result" id="verifyResult"></div>
            </div>

            <!-- Local Attestation History -->
            <div class="card">
                <div class="card-title">Your Attestation History</div>
                <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 1rem;">
                    Attestations submitted from this browser (stored locally)
                </p>
                <div id="attestationHistory">
                    <p style="color: var(--muted); text-align: center; padding: 1rem;">
                        No attestations yet
                    </p>
                </div>
            </div>
        </div>

        <!-- Contracts Panel -->
        <div class="panel" id="panel-contracts">
            <!-- Contract Actions -->
            <div class="card">
                <div class="card-title">Ricardian Contracts</div>
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    Multi-party contract signing with legally binding SPHINCS+ signatures.
                </p>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="showCreateContractModal()">
                        Create New Contract
                    </button>
                    <button class="btn btn-secondary" onclick="showSignContractModal()">
                        Sign Contract
                    </button>
                    <button class="btn btn-secondary" onclick="showViewContractModal()">
                        View Contract
                    </button>
                </div>
            </div>

            <!-- My Contracts -->
            <div class="card">
                <div class="card-title">Your Contracts</div>
                <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 1rem;">
                    Contracts you've created or been added to as a party.
                </p>
                <div id="myContracts">
                    <p style="color: var(--muted); text-align: center; padding: 1rem;">
                        No contracts yet. Create one or get invited to sign.
                    </p>
                </div>
            </div>

            <!-- Contract Types Reference -->
            <div class="card">
                <div class="card-title">Contract Types</div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
                    <div class="badge badge-info">Academic Program</div>
                    <div class="badge badge-info">Partnership</div>
                    <div class="badge badge-info">Service Agreement</div>
                    <div class="badge badge-info">NDA</div>
                    <div class="badge badge-info">Employment</div>
                    <div class="badge badge-info">License</div>
                    <div class="badge badge-info">Custom</div>
                </div>
            </div>
        </div>

        <!-- Fideicommis (Trust) Panel -->
        <div class="panel" id="panel-fideicommis">
            <!-- Create Trust Card -->
            <div class="card">
                <div class="card-title">
                    <span>Create Fideicommis</span>
                    <span class="badge badge-info">Civil Law Trust</span>
                </div>
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    A fideicommis allows assets to pass from a primary beneficiary (greve) to a substitute beneficiary (appele) at a specified time.
                </p>

                <div class="form-group">
                    <label class="form-label">Trust Name</label>
                    <input type="text" class="form-input" id="trustName" placeholder="e.g., Family Trust 2025">
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Greve (Primary Beneficiary)</label>
                        <input type="text" class="form-input" id="trustGreve" placeholder="Address or public key">
                        <div class="form-hint">Can claim funds before trigger date</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Appele (Substitute Beneficiary)</label>
                        <input type="text" class="form-input" id="trustAppele" placeholder="Address or public key">
                        <div class="form-hint">Receives remaining funds after trigger</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Trigger Date</label>
                        <input type="date" class="form-input" id="trustTriggerDate">
                        <div class="form-hint">When trust transfers to appele</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Initial Deposit (QMHY)</label>
                        <input type="number" class="form-input" id="trustDeposit" placeholder="1.0" step="0.000001" min="1">
                    </div>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="trustRevocable" checked>
                        <span><strong>Revocable</strong> - You can cancel the trust before trigger</span>
                    </label>
                </div>

                <button class="btn btn-primary btn-block" id="createTrustBtn" disabled>
                    Unlock Wallet to Create Trust
                </button>

                <div class="result" id="trustCreateResult"></div>
            </div>

            <!-- Your Trusts Card -->
            <div class="card">
                <div class="card-title">Your Trusts</div>
                <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 1rem;">
                    Trusts you've created or are a beneficiary of.
                </p>
                <div id="myTrusts">
                    <p style="color: var(--muted); text-align: center; padding: 1rem;">
                        No trusts yet. Create one above.
                    </p>
                </div>
            </div>

            <!-- Trust Info Card -->
            <div class="card">
                <div class="card-title">About Fideicommis</div>
                <p style="color: var(--muted);">
                    <strong>Civil Law Trust</strong> (Latin: fideicommissum)<br><br>
                    A Quebec/civil law mechanism where property passes through successive beneficiaries:
                </p>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                    <li><strong>Constituant:</strong> Creator who deposits funds (you)</li>
                    <li><strong>Greve:</strong> Primary beneficiary who can claim before trigger</li>
                    <li><strong>Appele:</strong> Substitute who receives remainder after trigger</li>
                </ul>
            </div>
        </div>

        <!-- QCAD Stablecoin Panel -->
        <div class="panel" id="panel-qcad">
            <!-- QCAD Balance Card -->
            <div class="card">
                <div class="card-title">
                    <span>QCAD Balance</span>
                    <span class="badge badge-success">Stablecoin</span>
                </div>
                <div style="text-align: center; padding: 1.5rem 0;">
                    <div style="font-size: 2.5rem; font-weight: bold; color: var(--primary);" id="qcadBalance">0.00</div>
                    <div style="color: var(--muted); margin-top: 0.25rem;">QCAD (1 QCAD = 1 CAD)</div>
                </div>
                <div class="grid-2" style="margin-top: 1rem;">
                    <div style="text-align: center;">
                        <div style="color: var(--muted); font-size: 0.8rem;">Current QMHY Price</div>
                        <div style="font-weight: bold;" id="qmhyPriceDisplay">$0.00 CAD</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="color: var(--muted); font-size: 0.8rem;">Total QCAD Supply</div>
                        <div style="font-weight: bold;" id="totalQcadSupply">0.00</div>
                    </div>
                </div>
            </div>

            <!-- Open Vault Card -->
            <div class="card">
                <div class="card-title">
                    <span>Open Vault</span>
                    <span class="badge badge-info">150% Collateral</span>
                </div>
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    Lock QMHY as collateral to mint QCAD stablecoin. Minimum 150% collateralization required.
                </p>

                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">QMHY Collateral</label>
                        <input type="number" class="form-input" id="vaultCollateral" placeholder="1500" step="0.000001" min="1">
                        <div class="form-hint">Amount of QMHY to lock</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">QCAD to Mint</label>
                        <input type="number" class="form-input" id="vaultDebt" placeholder="1000" step="0.01" min="100">
                        <div class="form-hint">Minimum 100 QCAD</div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Collateral Ratio</label>
                    <div class="file-info" id="vaultRatioPreview" style="margin-top: 0;">
                        Enter amounts above to see ratio
                    </div>
                </div>

                <button class="btn btn-primary btn-block" id="openVaultBtn" disabled>
                    Unlock Wallet to Open Vault
                </button>

                <div class="result" id="vaultCreateResult"></div>
            </div>

            <!-- Your Vaults Card -->
            <div class="card">
                <div class="card-title">Your Vaults</div>
                <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 1rem;">
                    Manage your collateral positions. Keep ratio above 120% to avoid liquidation.
                </p>
                <div id="myVaults">
                    <p style="color: var(--muted); text-align: center; padding: 1rem;">
                        No vaults yet. Open one above to start minting QCAD.
                    </p>
                </div>
            </div>

            <!-- Transfer QCAD Card -->
            <div class="card">
                <div class="card-title">Transfer QCAD</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Recipient Address</label>
                        <input type="text" class="form-input" id="qcadRecipient" placeholder="5G...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Amount (QCAD)</label>
                        <input type="number" class="form-input" id="qcadAmount" placeholder="100" step="0.01" min="0.01">
                    </div>
                </div>
                <button class="btn btn-secondary btn-block" id="transferQcadBtn" disabled>
                    Transfer QCAD
                </button>
                <div class="result" id="transferQcadResult"></div>
            </div>

            <!-- QCAD Info Card -->
            <div class="card">
                <div class="card-title">About QCAD</div>
                <p style="color: var(--muted);">
                    <strong>Canadian Dollar Stablecoin</strong><br><br>
                    QCAD is a decentralized stablecoin pegged 1:1 to the Canadian Dollar, backed by overcollateralized QMHY tokens.
                </p>
                <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                    <li><strong>Collateral Ratio:</strong> Minimum 150% required to mint</li>
                    <li><strong>Liquidation:</strong> Below 120% ratio, vault can be liquidated</li>
                    <li><strong>Stability Fee:</strong> 2% annual interest on minted QCAD</li>
                    <li><strong>Liquidation Penalty:</strong> 13% bonus for liquidators</li>
                </ul>
            </div>
        </div>

        <!-- Account Panel -->
        <div class="panel" id="panel-account">
            <div class="card">
                <div class="card-title">Account Management</div>

                <div class="grid-2" style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="showCreateAccountModal()">
                        Create New Account
                    </button>
                    <button class="btn btn-secondary" onclick="showImportModal()">
                        Import Keystore
                    </button>
                </div>

                <h4 style="margin-bottom: 0.75rem; font-size: 0.9rem; color: var(--muted);">Your Accounts</h4>
                <div class="account-list" id="accountList">
                    <p style="color: var(--muted); text-align: center; padding: 2rem;">
                        No accounts yet. Create or import one to get started.
                    </p>
                </div>
            </div>

            <div class="card" id="activeAccountCard" style="display: none;">
                <div class="card-title">Active Account</div>
                <div class="form-group">
                    <label class="form-label">Address</label>
                    <div class="file-info" id="activeAddress" style="margin-top: 0;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Public Key</label>
                    <div class="file-info" id="activePublicKey" style="margin-top: 0;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <span class="badge" id="accountStatus">Locked</span>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="panel" id="panel-settings">
            <div class="card">
                <div class="card-title">IPFS Configuration (Pinata)</div>
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    Configure Pinata to enable IPFS document storage. Get your API keys at
                    <a href="https://app.pinata.cloud/keys" target="_blank" style="color: var(--primary);">pinata.cloud</a>
                </p>

                <div class="form-group">
                    <label class="form-label">Pinata API Key</label>
                    <input type="text" class="form-input" id="pinataApiKey" placeholder="Enter your Pinata API key">
                </div>

                <div class="form-group">
                    <label class="form-label">Pinata Secret Key</label>
                    <input type="password" class="form-input" id="pinataSecretKey" placeholder="Enter your Pinata secret key">
                </div>

                <div class="form-group">
                    <label class="form-label">Preferred IPFS Gateway</label>
                    <select class="form-select" id="ipfsGateway">
                        <option value="https://gateway.pinata.cloud/ipfs/">Pinata Gateway</option>
                        <option value="https://ipfs.io/ipfs/">IPFS.io</option>
                        <option value="https://cloudflare-ipfs.com/ipfs/">Cloudflare</option>
                        <option value="https://dweb.link/ipfs/">DWeb.link</option>
                    </select>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="saveIPFSSettings()">Save Settings</button>
                    <button class="btn btn-secondary" onclick="testIPFSConnection()">Test Connection</button>
                </div>

                <div class="result" id="ipfsTestResult"></div>
            </div>

            <div class="card">
                <div class="card-title">About</div>
                <p style="color: var(--muted);">
                    <strong>QuantumHarmony Notarial Service</strong><br>
                    Post-quantum secure document attestation using SPHINCS+ signatures.<br><br>
                    <strong>Version:</strong> 1.0.0<br>
                    <strong>Chain:</strong> QuantumHarmony Production Testnet<br>
                    <strong>Notarial Pallet:</strong> Index 21
                </p>
            </div>
        </div>

        <footer>
            <p>QuantumHarmony Notarial Service - Post-Quantum Secure</p>
            <p><a href="https://t.me/paraxiom">Telegram</a> | <a href="https://github.com/QuantumVerseProtocols/quantumharmony">GitHub</a></p>
        </footer>
    </div>

    <!-- Account Modal -->
    <div class="modal-overlay" id="accountModal">
        <div class="modal">
            <div class="modal-title" id="accountModalTitle">Account</div>
            <div id="accountModalContent"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/keystore.js"></script>
    <script src="js/ipfs.js"></script>
    <script>
        // ==================== State ====================
        let currentFileHash = null;
        let verifyFileHash = null;
        let unlockedAccount = null;

        // ==================== Tab Navigation ====================
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
            });
        });

        // ==================== Connection ====================
        const rpcEndpoint = () => document.getElementById('rpcEndpoint').value;

        async function rpcCall(method, params = []) {
            const response = await fetch(rpcEndpoint(), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jsonrpc: '2.0', id: 1, method, params })
            });
            return await response.json();
        }

        async function checkConnection() {
            const dot = document.getElementById('connectionDot');
            const text = document.getElementById('connectionText');
            try {
                const result = await rpcCall('system_health');
                if (result.result) {
                    dot.classList.add('connected');
                    text.textContent = `Connected (${result.result.peers} peers)`;
                    return true;
                }
            } catch (e) {}
            dot.classList.remove('connected');
            text.textContent = 'Disconnected';
            return false;
        }

        document.getElementById('rpcEndpoint').addEventListener('change', checkConnection);
        checkConnection();
        setInterval(checkConnection, 30000);

        // ==================== File Hashing ====================
        const sha256 = (function() {
            const K = [
                0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
                0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
                0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
                0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
                0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
                0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
                0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
                0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
            ];
            const rotr = (n, x) => (x >>> n) | (x << (32 - n));
            const ch = (x, y, z) => (x & y) ^ (~x & z);
            const maj = (x, y, z) => (x & y) ^ (x & z) ^ (y & z);
            const sigma0 = x => rotr(2, x) ^ rotr(13, x) ^ rotr(22, x);
            const sigma1 = x => rotr(6, x) ^ rotr(11, x) ^ rotr(25, x);
            const gamma0 = x => rotr(7, x) ^ rotr(18, x) ^ (x >>> 3);
            const gamma1 = x => rotr(17, x) ^ rotr(19, x) ^ (x >>> 10);

            return function(data) {
                const bytes = new Uint8Array(data);
                let H = [0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19];
                const l = bytes.length;
                const k = (512 - ((l * 8 + 1 + 64) % 512)) % 512;
                const padded = new Uint8Array(l + 1 + (k / 8) + 8);
                padded.set(bytes);
                padded[l] = 0x80;
                const view = new DataView(padded.buffer);
                view.setUint32(padded.length - 4, l * 8, false);

                for (let i = 0; i < padded.length; i += 64) {
                    const W = new Uint32Array(64);
                    for (let t = 0; t < 16; t++) W[t] = view.getUint32(i + t * 4, false);
                    for (let t = 16; t < 64; t++) W[t] = (gamma1(W[t-2]) + W[t-7] + gamma0(W[t-15]) + W[t-16]) >>> 0;
                    let [a, b, c, d, e, f, g, h] = H;
                    for (let t = 0; t < 64; t++) {
                        const T1 = (h + sigma1(e) + ch(e, f, g) + K[t] + W[t]) >>> 0;
                        const T2 = (sigma0(a) + maj(a, b, c)) >>> 0;
                        h = g; g = f; f = e; e = (d + T1) >>> 0;
                        d = c; c = b; b = a; a = (T1 + T2) >>> 0;
                    }
                    H = H.map((v, i) => (v + [a,b,c,d,e,f,g,h][i]) >>> 0);
                }
                return H.map(v => v.toString(16).padStart(8, '0')).join('');
            };
        })();

        async function hashFile(file) {
            const buffer = await file.arrayBuffer();
            if (crypto.subtle) {
                const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                return '0x' + Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            return '0x' + sha256(buffer);
        }

        // ==================== File Upload Handlers ====================
        function setupDropZone(dropZoneId, fileInputId, fileInfoId, onHash) {
            const dropZone = document.getElementById(dropZoneId);
            const fileInput = document.getElementById(fileInputId);
            const fileInfo = document.getElementById(fileInfoId);

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', async e => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                if (e.dataTransfer.files.length) await processFile(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', async () => {
                if (fileInput.files.length) await processFile(fileInput.files[0]);
            });

            async function processFile(file) {
                fileInfo.style.display = 'block';
                fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Computing hash...</strong>`;
                const hash = await hashFile(file);
                fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Size:</strong> ${(file.size / 1024).toFixed(2)} KB<br><strong>SHA-256:</strong><br>${hash}`;
                onHash(hash);
            }
        }

        setupDropZone('attestDropZone', 'attestFileInput', 'attestFileInfo', hash => {
            currentFileHash = hash;
            updateAttestButton();
        });

        setupDropZone('verifyDropZone', 'verifyFileInput', 'verifyFileInfo', hash => {
            document.getElementById('verifyHash').value = hash;
        });

        // ==================== Account UI ====================
        function updateAccountUI() {
            const keystores = QHKeystore.loadKeystores();
            const active = QHKeystore.getActiveKeystore();
            const btn = document.getElementById('accountBtn');
            const btnText = document.getElementById('accountBtnText');

            if (!active) {
                btn.classList.remove('unlocked');
                btn.classList.add('locked');
                btnText.textContent = 'No Account';
                document.getElementById('activeAccountCard').style.display = 'none';
            } else if (unlockedAccount) {
                btn.classList.remove('locked');
                btn.classList.add('unlocked');
                btnText.textContent = active.meta.name;
                showActiveAccount(active);
            } else {
                btn.classList.remove('unlocked');
                btn.classList.add('locked');
                btnText.textContent = active.meta.name + ' (Locked)';
                showActiveAccount(active);
            }

            renderAccountList(keystores, active);
            updateAttestButton();
        }

        function showActiveAccount(keystore) {
            document.getElementById('activeAccountCard').style.display = 'block';
            document.getElementById('activeAddress').textContent = keystore.address;
            document.getElementById('activePublicKey').textContent = keystore.publicKey;

            const status = document.getElementById('accountStatus');
            if (unlockedAccount) {
                status.className = 'badge badge-success';
                status.textContent = 'Unlocked';
            } else {
                status.className = 'badge badge-warning';
                status.textContent = 'Locked';
            }
        }

        function renderAccountList(keystores, active) {
            const list = document.getElementById('accountList');
            if (keystores.length === 0) {
                list.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 2rem;">No accounts yet. Create or import one to get started.</p>';
                return;
            }

            list.innerHTML = keystores.map(k => `
                <div class="account-item ${k.id === active?.id ? 'active' : ''}" data-id="${k.id}">
                    <div class="account-item-info">
                        <div class="account-item-name">${k.meta.name}</div>
                        <div class="account-item-address">${k.address.slice(0, 20)}...</div>
                    </div>
                    <div class="account-item-actions">
                        ${k.id !== active?.id ? `<button class="btn btn-sm btn-secondary" onclick="selectAccount('${k.id}')">Select</button>` : ''}
                        <button class="btn btn-sm btn-secondary" onclick="exportAccount('${k.id}')">Export</button>
                    </div>
                </div>
            `).join('');
        }

        function selectAccount(id) {
            QHKeystore.setActiveKeystore(id);
            unlockedAccount = null;
            updateAccountUI();
        }

        function exportAccount(id) {
            const keystores = QHKeystore.loadKeystores();
            const keystore = keystores.find(k => k.id === id);
            if (keystore) QHKeystore.exportKeystore(keystore);
        }

        // ==================== Modals ====================
        function showModal(title, content) {
            document.getElementById('accountModalTitle').textContent = title;
            document.getElementById('accountModalContent').innerHTML = content;
            document.getElementById('accountModal').classList.add('show');
        }

        function hideModal() {
            document.getElementById('accountModal').classList.remove('show');
        }

        document.getElementById('accountModal').addEventListener('click', e => {
            if (e.target === document.getElementById('accountModal')) hideModal();
        });

        function showAccountModal() {
            const active = QHKeystore.getActiveKeystore();
            if (!active) {
                showCreateAccountModal();
                return;
            }

            if (unlockedAccount) {
                showModal('Account', `
                    <p><strong>Status:</strong> <span class="badge badge-success">Unlocked</span></p>
                    <p style="margin-top: 1rem;"><strong>Address:</strong></p>
                    <div class="file-info">${active.address}</div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="lockAccount()">Lock</button>
                        <button class="btn btn-secondary" onclick="hideModal()">Close</button>
                    </div>
                `);
            } else {
                showModal('Unlock Account', `
                    <p style="margin-bottom: 1rem;">Enter password to unlock <strong>${active.meta.name}</strong></p>
                    <div class="form-group">
                        <input type="password" class="form-input" id="unlockPassword" placeholder="Password">
                    </div>
                    <div id="unlockError" style="color: var(--error); font-size: 0.85rem; margin-bottom: 1rem; display: none;"></div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="doUnlock()">Unlock</button>
                    </div>
                `);
                setTimeout(() => document.getElementById('unlockPassword')?.focus(), 100);
            }
        }

        async function doUnlock() {
            const password = document.getElementById('unlockPassword').value;
            const active = QHKeystore.getActiveKeystore();
            const errorEl = document.getElementById('unlockError');

            try {
                unlockedAccount = await QHKeystore.unlockKeystore(active, password);
                hideModal();
                updateAccountUI();
            } catch (e) {
                errorEl.textContent = 'Invalid password';
                errorEl.style.display = 'block';
            }
        }

        function lockAccount() {
            unlockedAccount = null;
            hideModal();
            updateAccountUI();
        }

        function showCreateAccountModal() {
            const seedPhrase = QHKeystore.generateSeedPhrase();
            showModal('Create New Account', `
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="newAccountName" value="My Signing Key" placeholder="Account name">
                </div>
                <div class="form-group">
                    <label class="form-label">Recovery Seed Phrase</label>
                    <div class="seed-phrase" id="seedPhrase">${seedPhrase}</div>
                    <div class="seed-phrase-warning">
                        Write this down and store it safely. You'll need it to recover your account. Anyone with this phrase can access your funds.
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="newPassword" placeholder="Enter a strong password">
                    <div class="form-hint">Used to encrypt your keystore locally</div>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm password">
                </div>
                <div id="createError" style="color: var(--error); font-size: 0.85rem; display: none;"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="doCreateAccount()">Create Account</button>
                </div>
            `);
        }

        async function doCreateAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            const seedPhrase = document.getElementById('seedPhrase').textContent;
            const password = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const errorEl = document.getElementById('createError');

            if (!name) {
                errorEl.textContent = 'Please enter an account name';
                errorEl.style.display = 'block';
                return;
            }
            if (password.length < 8) {
                errorEl.textContent = 'Password must be at least 8 characters';
                errorEl.style.display = 'block';
                return;
            }
            if (password !== confirm) {
                errorEl.textContent = 'Passwords do not match';
                errorEl.style.display = 'block';
                return;
            }

            try {
                const keypair = QHKeystore.keypairFromSeed(seedPhrase);
                const keystore = await QHKeystore.createKeystore(keypair, password, name);
                QHKeystore.saveKeystore(keystore);
                hideModal();
                updateAccountUI();
            } catch (e) {
                errorEl.textContent = 'Error creating account: ' + e.message;
                errorEl.style.display = 'block';
            }
        }

        function showImportModal() {
            showModal('Import Keystore', `
                <p style="margin-bottom: 1rem;">Import an existing encrypted keystore file.</p>
                <div class="form-group">
                    <div class="drop-zone" id="importDropZone" style="padding: 1.5rem;">
                        <div>Drop keystore JSON file or click to select</div>
                        <input type="file" id="importFileInput" accept=".json">
                    </div>
                </div>
                <div id="importError" style="color: var(--error); font-size: 0.85rem; display: none;"></div>
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                </div>
            `);

            const dropZone = document.getElementById('importDropZone');
            const fileInput = document.getElementById('importFileInput');

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', async () => {
                if (fileInput.files.length) await importFile(fileInput.files[0]);
            });

            async function importFile(file) {
                try {
                    const keystore = await QHKeystore.importKeystoreFile(file);
                    QHKeystore.saveKeystore(keystore);
                    hideModal();
                    updateAccountUI();
                } catch (e) {
                    document.getElementById('importError').textContent = e.message;
                    document.getElementById('importError').style.display = 'block';
                }
            }
        }

        // ==================== Attestation ====================
        function updateAttestButton() {
            const btn = document.getElementById('attestBtn');
            if (!currentFileHash) {
                btn.disabled = true;
                btn.textContent = 'Select a Document';
            } else if (!unlockedAccount) {
                btn.disabled = false;
                btn.textContent = 'Unlock Wallet to Sign';
            } else {
                btn.disabled = false;
                btn.textContent = 'Submit Attestation';
            }
        }

        document.getElementById('attestBtn').addEventListener('click', async () => {
            if (!currentFileHash) return;

            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            const btn = document.getElementById('attestBtn');
            btn.disabled = true;

            try {
                const category = parseInt(document.getElementById('attestCategory').value);
                const validity = parseInt(document.getElementById('attestValidity').value);
                const description = document.getElementById('attestDescription').value;
                const storageOption = document.querySelector('input[name="storageOption"]:checked').value;

                let ipfsCid = null;
                let ipfsEncrypted = false;
                let encryptionKey = null;

                // Handle IPFS upload if selected
                if (storageOption !== 'local') {
                    if (!QHIPFS.isPinataConfigured()) {
                        showResult('attestResult', 'error', 'IPFS requires Pinata API keys. Configure in Settings tab.');
                        btn.disabled = false;
                        updateAttestButton();
                        return;
                    }

                    btn.innerHTML = '<span class="spinner"></span> Uploading to IPFS...';

                    const fileInput = document.getElementById('attestFileInput');
                    if (!fileInput.files.length) {
                        showResult('attestResult', 'error', 'Please select a file to upload to IPFS');
                        btn.disabled = false;
                        updateAttestButton();
                        return;
                    }

                    const file = fileInput.files[0];

                    try {
                        if (storageOption === 'ipfs-encrypted') {
                            encryptionKey = QHIPFS.generateEncryptionKey();
                            const uploadResult = await QHIPFS.uploadEncryptedToIPFS(file, encryptionKey);
                            ipfsCid = uploadResult.cid;
                            ipfsEncrypted = true;
                        } else {
                            const uploadResult = await QHIPFS.uploadToIPFS(file, {
                                name: file.name,
                                category: CATEGORIES[category]
                            });
                            ipfsCid = uploadResult.cid;
                        }
                    } catch (ipfsError) {
                        showResult('attestResult', 'error', `IPFS upload failed: ${ipfsError.message}`);
                        btn.disabled = false;
                        updateAttestButton();
                        return;
                    }
                }

                btn.innerHTML = '<span class="spinner"></span> Signing & Submitting...';

                // Build call data
                const NOTARIAL_PALLET_INDEX = 21;
                const ATTEST_CALL_INDEX = 0;

                const documentHash = QHKeystore.hexToBytes(currentFileHash);
                const descBytes = new TextEncoder().encode(description);

                // SCALE encode
                function encodeCompact(v) {
                    if (v < 64) return [v << 2];
                    if (v < 16384) return [(v << 2) | 1, v >> 6];
                    if (v < 1073741824) return [(v << 2) | 2, v >> 6, v >> 14, v >> 22];
                    const bytes = [];
                    while (v > 0) { bytes.push(v & 0xff); v = Math.floor(v / 256); }
                    return [((bytes.length - 4) << 2) | 3, ...bytes];
                }

                const callBytes = [
                    NOTARIAL_PALLET_INDEX,
                    ATTEST_CALL_INDEX,
                    ...documentHash,
                    category,
                    ...encodeCompact(descBytes.length),
                    ...descBytes,
                    validity > 0 ? 1 : 0,
                    ...(validity > 0 ? encodeCompact(validity) : []),
                    0, // None for contract_id
                    0  // None for academic_id
                ];

                const callData = QHKeystore.bytesToHex(new Uint8Array(callBytes));
                const signerKey = QHKeystore.bytesToHex(unlockedAccount.secretKey);

                const result = await rpcCall('quantumharmony_submitSignedExtrinsic', [{
                    callData: callData,
                    signerKey: signerKey
                }]);

                if (result.result && result.result.success) {
                    // Save to local history
                    const attestation = {
                        id: Date.now(),
                        documentHash: currentFileHash,
                        txHash: result.result.hash,
                        signer: unlockedAccount.address,
                        category: category,
                        description: description,
                        timestamp: new Date().toISOString(),
                        status: 'pending',
                        ipfsCid: ipfsCid,
                        ipfsEncrypted: ipfsEncrypted,
                        encryptionKey: encryptionKey ? QHKeystore.bytesToHex(encryptionKey) : null
                    };
                    saveAttestation(attestation);
                    renderAttestationHistory();

                    let successHtml = `
                        <strong>Document Attested Successfully!</strong><br>
                        <strong>Transaction:</strong> <code style="font-size: 0.75rem;">${result.result.hash}</code><br>
                        <strong>Document Hash:</strong> <code style="font-size: 0.75rem;">${currentFileHash}</code><br>
                        <strong>Signer:</strong> <code style="font-size: 0.75rem;">${unlockedAccount.address}</code><br>
                    `;

                    if (ipfsCid) {
                        const ipfsUrl = QHIPFS.getIPFSUrl(ipfsCid);
                        successHtml += `
                            <br><strong>IPFS CID:</strong> <code style="font-size: 0.75rem;">${ipfsCid}</code><br>
                            <strong>IPFS URL:</strong> <a href="${ipfsUrl}" target="_blank" style="color: var(--primary); font-size: 0.75rem;">${ipfsUrl.slice(0, 50)}...</a><br>
                        `;
                        if (ipfsEncrypted) {
                            successHtml += `
                                <br><div class="seed-phrase-warning" style="margin-top: 0.5rem;">
                                    <strong>Encryption Key (save this!):</strong><br>
                                    <code style="font-size: 0.7rem; word-break: break-all;">${QHKeystore.bytesToHex(encryptionKey)}</code>
                                </div>
                            `;
                        }
                    }

                    successHtml += `<br><span class="badge badge-success">Submitted to blockchain</span>`;
                    showResult('attestResult', 'success', successHtml);
                } else {
                    const err = result.error?.message || JSON.stringify(result);
                    showResult('attestResult', 'error', `Error: ${err}`);
                }
            } catch (e) {
                showResult('attestResult', 'error', `Error: ${e.message}`);
            }

            updateAttestButton();
        });

        // ==================== Verification ====================

        // Twox128 hash function for storage key prefix
        function twox128(data) {
            // Simplified xxhash64 x 2 - in production use proper xxhash
            // For now, we'll use the precomputed module prefixes
            const encoder = new TextEncoder();
            const bytes = typeof data === 'string' ? encoder.encode(data) : data;

            // Simple hash for demo - real implementation needs xxhash64
            let h1 = 0xcbf29ce484222325n;
            let h2 = 0x100000001b3n;
            for (const b of bytes) {
                h1 ^= BigInt(b);
                h1 *= 0x01000193n;
                h1 &= 0xffffffffffffffffn;
                h2 ^= BigInt(b);
                h2 *= 0x01000193n;
                h2 &= 0xffffffffffffffffn;
            }

            const result = new Uint8Array(16);
            for (let i = 0; i < 8; i++) {
                result[i] = Number((h1 >> BigInt(i * 8)) & 0xffn);
                result[8 + i] = Number((h2 >> BigInt(i * 8)) & 0xffn);
            }
            return result;
        }

        // Blake2-128 concat for storage key
        function blake2_128Concat(data) {
            // Simplified - hash + data concatenated
            const hash = sha256(data).slice(0, 32); // Use first 16 bytes of sha256 as approximation
            const hashBytes = QHKeystore.hexToBytes('0x' + hash);
            const dataBytes = data instanceof Uint8Array ? data : QHKeystore.hexToBytes(data);
            const result = new Uint8Array(16 + dataBytes.length);
            result.set(hashBytes.slice(0, 16), 0);
            result.set(dataBytes, 16);
            return result;
        }

        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const hash = document.getElementById('verifyHash').value;
            if (!hash) {
                showResult('verifyResult', 'error', 'Please upload a file or enter a document hash');
                return;
            }

            const btn = document.getElementById('verifyBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Querying blockchain...';

            try {
                // First, try to get attestation by hash using runtime API
                // Query the Notarial pallet storage: AttestationByHash

                // Method 1: Try state_call if available
                // Method 2: Query storage directly

                // For now, let's query the chain and check if we can find the attestation
                // We'll use state_getKeys to find matching storage keys

                const documentHash = hash.startsWith('0x') ? hash : '0x' + hash;

                // Query current block info
                const headerResult = await rpcCall('chain_getHeader');
                const currentBlock = parseInt(headerResult.result?.number || '0', 16);

                // Try to find attestation via events or storage query
                // Since direct storage query needs exact key format, let's provide guidance

                showResult('verifyResult', 'info', `
                    <strong>Document Hash:</strong><br>
                    <code style="word-break: break-all; font-size: 0.75rem;">${documentHash}</code>

                    <hr style="border-color: var(--border); margin: 1rem 0;">

                    <strong>Current Block:</strong> #${currentBlock.toLocaleString()}

                    <hr style="border-color: var(--border); margin: 1rem 0;">

                    <strong>Verification Methods:</strong>
                    <ol style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                        <li>If you just attested, check the transaction hash in block explorer</li>
                        <li>Query chain state: <code>notarial.attestationByHash(hash)</code></li>
                        <li>The attestation includes: attester, block number, category, witnesses</li>
                    </ol>

                    <hr style="border-color: var(--border); margin: 1rem 0;">

                    <strong>Query via RPC:</strong><br>
                    <code style="font-size: 0.7rem; word-break: break-all;">
                    curl -X POST ${rpcEndpoint()} -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"state_getKeys","params":["0x"]}'
                    </code>
                `);

            } catch (e) {
                showResult('verifyResult', 'error', `Error: ${e.message}`);
            }

            btn.disabled = false;
            btn.textContent = 'Verify Document';
        });

        function showResult(id, type, html) {
            const el = document.getElementById(id);
            el.className = `result show ${type}`;
            el.innerHTML = html;
        }

        // ==================== Attestation History ====================
        const CATEGORIES = ['Academic', 'Legal', 'Contract', 'IP', 'Identity', 'Financial', 'Medical', 'Other'];

        function saveAttestation(attestation) {
            const history = JSON.parse(localStorage.getItem('qh_attestations') || '[]');
            history.unshift(attestation);
            // Keep last 50
            if (history.length > 50) history.pop();
            localStorage.setItem('qh_attestations', JSON.stringify(history));
        }

        function loadAttestations() {
            return JSON.parse(localStorage.getItem('qh_attestations') || '[]');
        }

        function renderAttestationHistory() {
            const history = loadAttestations();
            const container = document.getElementById('attestationHistory');

            if (history.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No attestations yet</p>';
                return;
            }

            container.innerHTML = history.slice(0, 10).map(a => `
                <div class="account-item" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <span class="badge badge-info">${CATEGORIES[a.category] || 'Other'}</span>
                        <span style="font-size: 0.75rem; color: var(--muted);">${new Date(a.timestamp).toLocaleDateString()}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--muted); word-break: break-all;">
                        ${a.description || 'No description'}
                    </div>
                    <div style="font-size: 0.7rem; font-family: monospace; word-break: break-all;">
                        Hash: ${a.documentHash.slice(0, 20)}...${a.documentHash.slice(-8)}
                    </div>
                    <div style="font-size: 0.7rem; font-family: monospace; word-break: break-all; color: var(--success);">
                        Tx: ${a.txHash ? a.txHash.slice(0, 20) + '...' : 'pending'}
                    </div>
                </div>
            `).join('');
        }

        // ==================== Ricardian Contracts ====================
        const CONTRACT_TYPES = ['Academic Program', 'Partnership', 'Service', 'NDA', 'Employment', 'License', 'Custom'];
        const CONTRACT_STATUS = ['Draft', 'Active', 'Executed', 'Terminated', 'Expired'];
        const RICARDIAN_PALLET_INDEX = 20;

        // Contract local storage
        function saveContract(contract) {
            const contracts = JSON.parse(localStorage.getItem('qh_contracts') || '[]');
            const existingIdx = contracts.findIndex(c => c.id === contract.id);
            if (existingIdx >= 0) {
                contracts[existingIdx] = contract;
            } else {
                contracts.unshift(contract);
            }
            localStorage.setItem('qh_contracts', JSON.stringify(contracts));
        }

        function loadContracts() {
            return JSON.parse(localStorage.getItem('qh_contracts') || '[]');
        }

        function renderMyContracts() {
            const contracts = loadContracts();
            const container = document.getElementById('myContracts');

            if (contracts.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No contracts yet. Create one or get invited to sign.</p>';
                return;
            }

            container.innerHTML = contracts.slice(0, 10).map(c => `
                <div class="account-item" style="flex-direction: column; align-items: flex-start; gap: 0.5rem; cursor: pointer;" onclick="viewContract(${c.id})">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <strong>${c.title || 'Untitled Contract'}</strong>
                        <span class="badge ${c.status === 'Active' ? 'badge-success' : c.status === 'Draft' ? 'badge-warning' : 'badge-info'}">${c.status || 'Draft'}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--muted);">
                        ${CONTRACT_TYPES[c.contractType] || 'Custom'} | ${c.parties?.length || 0} parties | ${c.signaturesCollected || 0}/${c.parties?.length || 0} signed
                    </div>
                    <div style="font-size: 0.7rem; font-family: monospace; color: var(--muted);">
                        ID: ${c.onChainId || 'pending'} | Created: ${new Date(c.createdAt).toLocaleDateString()}
                    </div>
                </div>
            `).join('');
        }

        function showCreateContractModal() {
            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            showModal('Create Ricardian Contract', `
                <div id="contractWizard">
                    <!-- Step 1: Basic Info -->
                    <div id="wizardStep1">
                        <div class="form-group">
                            <label class="form-label">Contract Title</label>
                            <input type="text" class="form-input" id="contractTitle" placeholder="e.g., Software Development Agreement">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Contract Type</label>
                            <select class="form-select" id="contractType">
                                <option value="0">Academic Program</option>
                                <option value="1">Partnership</option>
                                <option value="2" selected>Service Agreement</option>
                                <option value="3">NDA</option>
                                <option value="4">Employment</option>
                                <option value="5">License</option>
                                <option value="6">Custom</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Contract Document</label>
                            <div class="drop-zone" id="contractDropZone" style="padding: 1rem;">
                                <div>Drop contract PDF/document or click to select</div>
                                <input type="file" id="contractFileInput">
                            </div>
                            <div class="file-info" id="contractFileInfo" style="display: none; margin-top: 0.5rem;"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Expiration (optional)</label>
                            <input type="date" class="form-input" id="contractExpiration">
                            <div class="form-hint">Leave empty for no expiration</div>
                        </div>

                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                            <button class="btn btn-primary" onclick="wizardStep2()">Next: Add Parties</button>
                        </div>
                    </div>

                    <!-- Step 2: Parties -->
                    <div id="wizardStep2" style="display: none;">
                        <p style="color: var(--muted); margin-bottom: 1rem;">Add parties who need to sign this contract.</p>

                        <div id="partiesList"></div>

                        <div class="form-group" style="background: var(--bg); padding: 1rem; border-radius: 0.5rem;">
                            <label class="form-label">Add Party</label>
                            <input type="text" class="form-input" id="partyAddress" placeholder="Public key or address" style="margin-bottom: 0.5rem;">
                            <input type="text" class="form-input" id="partyRole" placeholder="Role (e.g., Buyer, Seller, Witness)">
                            <button class="btn btn-secondary btn-sm" style="margin-top: 0.5rem;" onclick="addPartyToList()">+ Add Party</button>
                        </div>

                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="wizardBack1()">Back</button>
                            <button class="btn btn-primary" onclick="wizardStep3()">Next: Review</button>
                        </div>
                    </div>

                    <!-- Step 3: Review & Submit -->
                    <div id="wizardStep3" style="display: none;">
                        <div id="contractReview"></div>

                        <div id="createContractError" style="color: var(--error); font-size: 0.85rem; display: none; margin-bottom: 1rem;"></div>

                        <div class="modal-actions">
                            <button class="btn btn-secondary" onclick="wizardBack2()">Back</button>
                            <button class="btn btn-primary" id="createContractBtn" onclick="createContract()">Create Contract</button>
                        </div>
                    </div>
                </div>
            `);

            // Setup file drop zone
            setTimeout(() => {
                const dropZone = document.getElementById('contractDropZone');
                const fileInput = document.getElementById('contractFileInput');
                const fileInfo = document.getElementById('contractFileInfo');

                if (dropZone && fileInput) {
                    dropZone.addEventListener('click', () => fileInput.click());
                    fileInput.addEventListener('change', async () => {
                        if (fileInput.files.length) {
                            const file = fileInput.files[0];
                            fileInfo.style.display = 'block';
                            fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Computing hash...</strong>`;
                            const hash = await hashFile(file);
                            fileInfo.innerHTML = `<strong>File:</strong> ${file.name}<br><strong>Hash:</strong> ${hash.slice(0, 20)}...`;
                            window.contractDocumentHash = hash;
                            window.contractFile = file;
                        }
                    });
                }
            }, 100);

            window.contractParties = [];
        }

        function addPartyToList() {
            const address = document.getElementById('partyAddress').value.trim();
            const role = document.getElementById('partyRole').value.trim();

            if (!address || !role) {
                alert('Please enter both address and role');
                return;
            }

            window.contractParties.push({ address, role, signed: false });
            document.getElementById('partyAddress').value = '';
            document.getElementById('partyRole').value = '';

            renderPartiesList();
        }

        function removeParty(index) {
            window.contractParties.splice(index, 1);
            renderPartiesList();
        }

        function renderPartiesList() {
            const container = document.getElementById('partiesList');
            if (!window.contractParties || window.contractParties.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 0.5rem;">No parties added yet</p>';
                return;
            }

            container.innerHTML = window.contractParties.map((p, i) => `
                <div class="account-item" style="margin-bottom: 0.5rem;">
                    <div class="account-item-info">
                        <div class="account-item-name">${p.role}</div>
                        <div class="account-item-address">${p.address.slice(0, 20)}...</div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeParty(${i})">Remove</button>
                </div>
            `).join('');
        }

        function wizardStep2() {
            const title = document.getElementById('contractTitle').value.trim();
            if (!title) {
                alert('Please enter a contract title');
                return;
            }
            if (!window.contractDocumentHash) {
                alert('Please upload a contract document');
                return;
            }

            document.getElementById('wizardStep1').style.display = 'none';
            document.getElementById('wizardStep2').style.display = 'block';
            renderPartiesList();
        }

        function wizardBack1() {
            document.getElementById('wizardStep1').style.display = 'block';
            document.getElementById('wizardStep2').style.display = 'none';
        }

        function wizardStep3() {
            if (!window.contractParties || window.contractParties.length === 0) {
                alert('Please add at least one party');
                return;
            }

            document.getElementById('wizardStep2').style.display = 'none';
            document.getElementById('wizardStep3').style.display = 'block';

            // Show review
            const title = document.getElementById('contractTitle').value;
            const type = CONTRACT_TYPES[document.getElementById('contractType').value];
            const expiration = document.getElementById('contractExpiration').value;

            document.getElementById('contractReview').innerHTML = `
                <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <p><strong>Title:</strong> ${title}</p>
                    <p><strong>Type:</strong> ${type}</p>
                    <p><strong>Document Hash:</strong> <code style="font-size: 0.7rem;">${window.contractDocumentHash?.slice(0, 30)}...</code></p>
                    <p><strong>Expiration:</strong> ${expiration || 'None'}</p>
                    <p><strong>Parties:</strong> ${window.contractParties.length}</p>
                    <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                        ${window.contractParties.map(p => `<li>${p.role}: ${p.address.slice(0, 15)}...</li>`).join('')}
                    </ul>
                </div>
                <p style="color: var(--warning); font-size: 0.85rem;">
                    This will create a contract on-chain. All parties will need to sign for the contract to become active.
                </p>
            `;
        }

        function wizardBack2() {
            document.getElementById('wizardStep2').style.display = 'block';
            document.getElementById('wizardStep3').style.display = 'none';
        }

        async function createContract() {
            const btn = document.getElementById('createContractBtn');
            const errorEl = document.getElementById('createContractError');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creating...';
            errorEl.style.display = 'none';

            try {
                const title = document.getElementById('contractTitle').value.trim();
                const contractType = parseInt(document.getElementById('contractType').value);
                const expiration = document.getElementById('contractExpiration').value;
                const documentHash = QHKeystore.hexToBytes(window.contractDocumentHash);

                // SCALE encode the create_contract call
                const titleBytes = new TextEncoder().encode(title);

                function encodeCompact(v) {
                    if (v < 64) return [v << 2];
                    if (v < 16384) return [(v << 2) | 1, v >> 6];
                    if (v < 1073741824) return [(v << 2) | 2, v >> 6, v >> 14, v >> 22];
                    const bytes = [];
                    while (v > 0) { bytes.push(v & 0xff); v = Math.floor(v / 256); }
                    return [((bytes.length - 4) << 2) | 3, ...bytes];
                }

                // Call: create_contract(title, contract_type_id, document_hash, expires_at, academic_program_id)
                const CREATE_CONTRACT_CALL = 0;

                const callBytes = [
                    RICARDIAN_PALLET_INDEX,
                    CREATE_CONTRACT_CALL,
                    ...encodeCompact(titleBytes.length),
                    ...titleBytes,
                    contractType,
                    ...documentHash,
                    0, // None for expires_at (simplified)
                    0  // None for academic_program_id
                ];

                const callData = QHKeystore.bytesToHex(new Uint8Array(callBytes));
                const signerKey = QHKeystore.bytesToHex(unlockedAccount.secretKey);

                const result = await rpcCall('quantumharmony_submitSignedExtrinsic', [{
                    callData: callData,
                    signerKey: signerKey
                }]);

                if (result.result && result.result.success) {
                    // Save contract locally
                    const contract = {
                        id: Date.now(),
                        title: title,
                        contractType: contractType,
                        documentHash: window.contractDocumentHash,
                        status: 'Draft',
                        creator: unlockedAccount.address,
                        createdAt: new Date().toISOString(),
                        parties: window.contractParties,
                        signaturesCollected: 0,
                        txHash: result.result.hash,
                        onChainId: null // Would need to parse events to get actual ID
                    };
                    saveContract(contract);
                    renderMyContracts();

                    hideModal();
                    showModal('Contract Created', `
                        <div class="result success show">
                            <strong>Contract created successfully!</strong><br><br>
                            <strong>Title:</strong> ${title}<br>
                            <strong>Transaction:</strong> <code style="font-size: 0.75rem;">${result.result.hash}</code><br><br>
                            <p style="color: var(--muted);">
                                Next steps:<br>
                                1. Share the contract ID with all parties<br>
                                2. Each party signs using "Sign Contract"<br>
                                3. Contract becomes Active when all sign
                            </p>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-primary" onclick="hideModal()">Done</button>
                        </div>
                    `);
                } else {
                    errorEl.textContent = result.error?.message || JSON.stringify(result);
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
            }

            btn.disabled = false;
            btn.textContent = 'Create Contract';
        }

        function showSignContractModal() {
            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            showModal('Sign Contract', `
                <p style="color: var(--muted); margin-bottom: 1rem;">
                    Enter the contract ID to sign. You must be listed as a party.
                </p>

                <div class="form-group">
                    <label class="form-label">Contract ID</label>
                    <input type="number" class="form-input" id="signContractId" placeholder="Enter contract ID">
                </div>

                <div id="signContractError" style="color: var(--error); font-size: 0.85rem; display: none; margin-bottom: 1rem;"></div>
                <div id="signContractSuccess" class="result success" style="display: none;"></div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideModal()">Cancel</button>
                    <button class="btn btn-primary" id="signContractBtn" onclick="signContract()">Sign Contract</button>
                </div>
            `);
        }

        async function signContract() {
            const contractId = parseInt(document.getElementById('signContractId').value);
            const btn = document.getElementById('signContractBtn');
            const errorEl = document.getElementById('signContractError');
            const successEl = document.getElementById('signContractSuccess');

            if (!contractId && contractId !== 0) {
                errorEl.textContent = 'Please enter a contract ID';
                errorEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Signing...';
            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            try {
                // Call: sign_contract(contract_id)
                const SIGN_CONTRACT_CALL = 3;

                // Encode contract_id as u32 (4 bytes little-endian)
                const idBytes = [
                    contractId & 0xff,
                    (contractId >> 8) & 0xff,
                    (contractId >> 16) & 0xff,
                    (contractId >> 24) & 0xff
                ];

                const callBytes = [
                    RICARDIAN_PALLET_INDEX,
                    SIGN_CONTRACT_CALL,
                    ...idBytes
                ];

                const callData = QHKeystore.bytesToHex(new Uint8Array(callBytes));
                const signerKey = QHKeystore.bytesToHex(unlockedAccount.secretKey);

                const result = await rpcCall('quantumharmony_submitSignedExtrinsic', [{
                    callData: callData,
                    signerKey: signerKey
                }]);

                if (result.result && result.result.success) {
                    successEl.innerHTML = `
                        <strong>Contract signed successfully!</strong><br>
                        <strong>Transaction:</strong> <code style="font-size: 0.75rem;">${result.result.hash}</code>
                    `;
                    successEl.style.display = 'block';

                    // Update local contract if we have it
                    const contracts = loadContracts();
                    const contract = contracts.find(c => c.onChainId === contractId);
                    if (contract) {
                        contract.signaturesCollected = (contract.signaturesCollected || 0) + 1;
                        if (contract.signaturesCollected >= contract.parties?.length) {
                            contract.status = 'Active';
                        }
                        saveContract(contract);
                        renderMyContracts();
                    }
                } else {
                    errorEl.textContent = result.error?.message || JSON.stringify(result);
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.textContent = e.message;
                errorEl.style.display = 'block';
            }

            btn.disabled = false;
            btn.textContent = 'Sign Contract';
        }

        function showViewContractModal() {
            showModal('View Contract', `
                <div class="form-group">
                    <label class="form-label">Contract ID</label>
                    <input type="number" class="form-input" id="viewContractId" placeholder="Enter contract ID">
                </div>

                <div id="contractDetails" style="display: none;"></div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideModal()">Close</button>
                    <button class="btn btn-primary" onclick="viewContractById()">View</button>
                </div>
            `);
        }

        function viewContractById() {
            const contractId = parseInt(document.getElementById('viewContractId').value);

            // Check local contracts first
            const contracts = loadContracts();
            const contract = contracts.find(c => c.id === contractId || c.onChainId === contractId);

            const detailsEl = document.getElementById('contractDetails');
            detailsEl.style.display = 'block';

            if (contract) {
                detailsEl.innerHTML = `
                    <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem;">
                        <h4 style="margin-bottom: 0.5rem;">${contract.title}</h4>
                        <p><strong>Status:</strong> <span class="badge ${contract.status === 'Active' ? 'badge-success' : 'badge-warning'}">${contract.status}</span></p>
                        <p><strong>Type:</strong> ${CONTRACT_TYPES[contract.contractType]}</p>
                        <p><strong>Document Hash:</strong><br><code style="font-size: 0.7rem; word-break: break-all;">${contract.documentHash}</code></p>
                        <p><strong>Created:</strong> ${new Date(contract.createdAt).toLocaleString()}</p>
                        <p><strong>Signatures:</strong> ${contract.signaturesCollected || 0}/${contract.parties?.length || 0}</p>
                        ${contract.parties ? `
                            <p><strong>Parties:</strong></p>
                            <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                                ${contract.parties.map(p => `<li>${p.role}: ${p.address.slice(0, 15)}... ${p.signed ? '(signed)' : ''}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                `;
            } else {
                detailsEl.innerHTML = `
                    <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; text-align: center; color: var(--muted);">
                        Contract not found locally. Query on-chain state for details.
                    </div>
                `;
            }
        }

        function viewContract(id) {
            const contracts = loadContracts();
            const contract = contracts.find(c => c.id === id);
            if (contract) {
                showModal('Contract Details', `
                    <div style="background: var(--bg); padding: 1rem; border-radius: 0.5rem;">
                        <h4 style="margin-bottom: 0.5rem;">${contract.title}</h4>
                        <p><strong>Status:</strong> <span class="badge ${contract.status === 'Active' ? 'badge-success' : 'badge-warning'}">${contract.status}</span></p>
                        <p><strong>Type:</strong> ${CONTRACT_TYPES[contract.contractType]}</p>
                        <p><strong>Document Hash:</strong><br><code style="font-size: 0.7rem; word-break: break-all;">${contract.documentHash}</code></p>
                        <p><strong>Transaction:</strong><br><code style="font-size: 0.7rem; word-break: break-all;">${contract.txHash || 'N/A'}</code></p>
                        <p><strong>Created:</strong> ${new Date(contract.createdAt).toLocaleString()}</p>
                        <p><strong>Signatures:</strong> ${contract.signaturesCollected || 0}/${contract.parties?.length || 0}</p>
                        ${contract.parties ? `
                            <p><strong>Parties:</strong></p>
                            <ul style="margin: 0.5rem 0 0 1.5rem; color: var(--muted);">
                                ${contract.parties.map(p => `<li>${p.role}: ${p.address.slice(0, 15)}... ${p.signed ? '(signed)' : ''}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="hideModal()">Close</button>
                    </div>
                `);
            }
        }

        // ==================== IPFS Settings ====================
        function loadIPFSSettings() {
            const config = QHIPFS.loadIPFSConfig();
            document.getElementById('pinataApiKey').value = config.pinataApiKey || '';
            document.getElementById('pinataSecretKey').value = config.pinataSecretKey || '';
            document.getElementById('ipfsGateway').value = config.preferredGateway || 'https://gateway.pinata.cloud/ipfs/';
            updateIPFSHint();
        }

        function saveIPFSSettings() {
            const config = {
                pinataApiKey: document.getElementById('pinataApiKey').value.trim(),
                pinataSecretKey: document.getElementById('pinataSecretKey').value.trim(),
                preferredGateway: document.getElementById('ipfsGateway').value
            };
            QHIPFS.saveIPFSConfig(config);
            showResult('ipfsTestResult', 'success', 'Settings saved successfully!');
            updateIPFSHint();
        }

        async function testIPFSConnection() {
            showResult('ipfsTestResult', 'info', '<span class="spinner"></span> Testing connection...');
            const result = await QHIPFS.testPinataConnection();
            if (result.success) {
                showResult('ipfsTestResult', 'success', 'Connection successful! Pinata is configured correctly.');
            } else {
                showResult('ipfsTestResult', 'error', `Connection failed: ${result.error}`);
            }
        }

        function updateIPFSHint() {
            const hint = document.getElementById('ipfsConfigHint');
            const configured = QHIPFS.isPinataConfigured();
            hint.style.display = configured ? 'none' : 'block';
        }

        // Check IPFS option selection
        document.querySelectorAll('input[name="storageOption"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const value = document.querySelector('input[name="storageOption"]:checked').value;
                if (value !== 'local' && !QHIPFS.isPinataConfigured()) {
                    document.getElementById('ipfsConfigHint').style.display = 'block';
                } else {
                    document.getElementById('ipfsConfigHint').style.display = 'none';
                }
            });
        });

        // ==================== Fideicommis (Trust) ====================
        const FIDEICOMMIS_PALLET_INDEX = 22;
        const TRUST_STATUS = ['Pending', 'Active', 'Triggered', 'Completed', 'Cancelled'];
        const BLOCKS_PER_DAY = 28800; // At 3s blocks

        // Local storage for trusts
        function saveTrust(trust) {
            const trusts = JSON.parse(localStorage.getItem('qh_trusts') || '[]');
            const existingIdx = trusts.findIndex(t => t.id === trust.id);
            if (existingIdx >= 0) {
                trusts[existingIdx] = trust;
            } else {
                trusts.unshift(trust);
            }
            localStorage.setItem('qh_trusts', JSON.stringify(trusts));
        }

        function loadTrusts() {
            return JSON.parse(localStorage.getItem('qh_trusts') || '[]');
        }

        // Convert date to block number
        function dateToBlockNumber(dateStr) {
            const targetDate = new Date(dateStr);
            const now = new Date();
            const daysUntil = Math.ceil((targetDate - now) / (1000 * 60 * 60 * 24));
            // Get current block and add days worth of blocks
            // For now, estimate based on days
            return daysUntil * BLOCKS_PER_DAY;
        }

        // Convert block number to estimated date
        function blockToDate(blockNumber, currentBlock) {
            const blocksUntil = blockNumber - currentBlock;
            const daysUntil = blocksUntil / BLOCKS_PER_DAY;
            const date = new Date();
            date.setDate(date.getDate() + daysUntil);
            return date.toLocaleDateString();
        }

        // Update create trust button state
        function updateTrustButton() {
            const btn = document.getElementById('createTrustBtn');
            const name = document.getElementById('trustName').value;
            const greve = document.getElementById('trustGreve').value;
            const appele = document.getElementById('trustAppele').value;
            const triggerDate = document.getElementById('trustTriggerDate').value;
            const deposit = document.getElementById('trustDeposit').value;

            if (!name || !greve || !appele || !triggerDate || !deposit) {
                btn.disabled = true;
                btn.textContent = 'Fill All Fields';
            } else if (!unlockedAccount) {
                btn.disabled = false;
                btn.textContent = 'Unlock Wallet to Create Trust';
            } else {
                btn.disabled = false;
                btn.textContent = 'Create Trust';
            }
        }

        // Add event listeners to trust form
        ['trustName', 'trustGreve', 'trustAppele', 'trustTriggerDate', 'trustDeposit'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateTrustButton);
        });

        document.getElementById('createTrustBtn')?.addEventListener('click', async () => {
            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            const btn = document.getElementById('createTrustBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creating Trust...';

            try {
                const name = document.getElementById('trustName').value.trim();
                const greve = document.getElementById('trustGreve').value.trim();
                const appele = document.getElementById('trustAppele').value.trim();
                const triggerDate = document.getElementById('trustTriggerDate').value;
                const depositQMHY = parseFloat(document.getElementById('trustDeposit').value);
                const revocable = document.getElementById('trustRevocable').checked;

                // Convert deposit to smallest unit (18 decimals)
                const depositAmount = BigInt(Math.floor(depositQMHY * 1e18));

                // Calculate trigger block
                const triggerBlocks = dateToBlockNumber(triggerDate);
                if (triggerBlocks < 28800) { // Less than 1 day
                    throw new Error('Trigger date must be at least 1 day in the future');
                }

                // Get current block to calculate absolute trigger block
                const headerResult = await rpcCall('chain_getHeader');
                const currentBlock = parseInt(headerResult.result?.number || '0', 16);
                const triggerBlock = currentBlock + triggerBlocks;

                // Encode name
                const nameBytes = new TextEncoder().encode(name);

                function encodeCompact(v) {
                    if (v < 64) return [v << 2];
                    if (v < 16384) return [(v << 2) | 1, v >> 6];
                    if (v < 1073741824) return [(v << 2) | 2, v >> 6, v >> 14, v >> 22];
                    const bytes = [];
                    while (v > 0) { bytes.push(v & 0xff); v = Math.floor(v / 256); }
                    return [((bytes.length - 4) << 2) | 3, ...bytes];
                }

                function encodeU64LE(v) {
                    const bytes = [];
                    for (let i = 0; i < 8; i++) {
                        bytes.push(Number(BigInt(v) >> BigInt(i * 8) & 0xffn));
                    }
                    return bytes;
                }

                function encodeBalance(v) {
                    // Balance is u128 (16 bytes little endian)
                    const bytes = [];
                    let val = BigInt(v);
                    for (let i = 0; i < 16; i++) {
                        bytes.push(Number(val & 0xffn));
                        val = val >> 8n;
                    }
                    return bytes;
                }

                // For simplicity, we'll use the caller as fiduciary
                // In a real implementation, addresses would need proper encoding
                // This is a placeholder that shows the intent

                // Call: create(name, fiduciary, greve, appele, trigger_block, greve_claim_before, initial_deposit, revocable)
                const CREATE_CALL_INDEX = 0;

                // Note: This is simplified - real implementation needs proper address encoding
                const callBytes = [
                    FIDEICOMMIS_PALLET_INDEX,
                    CREATE_CALL_INDEX,
                    ...encodeCompact(nameBytes.length),
                    ...nameBytes,
                    // For now, we'll note that full implementation needs address encoding
                    // The call data would include fiduciary, greve, appele as MultiAddress
                ];

                // Since we don't have the full SCALE encoding for addresses,
                // we'll save the trust locally and show a placeholder
                const trust = {
                    id: Date.now(),
                    name: name,
                    constituant: unlockedAccount.address,
                    greve: greve,
                    appele: appele,
                    triggerBlock: triggerBlock,
                    triggerDate: triggerDate,
                    deposit: depositQMHY,
                    revocable: revocable,
                    status: 'Pending',
                    createdAt: new Date().toISOString(),
                    onChainId: null, // Will be set when submitted
                };

                saveTrust(trust);
                renderMyTrusts();

                showResult('trustCreateResult', 'info', `
                    <strong>Trust Created Locally</strong><br><br>
                    <strong>Name:</strong> ${name}<br>
                    <strong>Greve:</strong> ${greve.slice(0, 20)}...<br>
                    <strong>Appele:</strong> ${appele.slice(0, 20)}...<br>
                    <strong>Trigger:</strong> ${triggerDate} (Block ~${triggerBlock})<br>
                    <strong>Deposit:</strong> ${depositQMHY} QMHY<br>
                    <strong>Revocable:</strong> ${revocable ? 'Yes' : 'No'}<br><br>
                    <span class="badge badge-warning">Note: On-chain submission requires pallet deployment</span>
                `);

                // Clear form
                document.getElementById('trustName').value = '';
                document.getElementById('trustGreve').value = '';
                document.getElementById('trustAppele').value = '';
                document.getElementById('trustTriggerDate').value = '';
                document.getElementById('trustDeposit').value = '';

            } catch (e) {
                showResult('trustCreateResult', 'error', `Error: ${e.message}`);
            }

            updateTrustButton();
        });

        function renderMyTrusts() {
            const trusts = loadTrusts();
            const container = document.getElementById('myTrusts');

            if (!trusts || trusts.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No trusts yet. Create one above.</p>';
                return;
            }

            container.innerHTML = trusts.map(t => `
                <div class="account-item" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                        <strong>${t.name}</strong>
                        <span class="badge ${t.status === 'Active' ? 'badge-success' : t.status === 'Triggered' ? 'badge-warning' : 'badge-info'}">${t.status}</span>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--muted);">
                        Greve: ${t.greve?.slice(0, 15)}... | Appele: ${t.appele?.slice(0, 15)}...
                    </div>
                    <div style="font-size: 0.8rem; color: var(--muted);">
                        Trigger: ${t.triggerDate} | Deposit: ${t.deposit} QMHY
                    </div>
                    <div style="font-size: 0.7rem; font-family: monospace; color: var(--muted);">
                        Created: ${new Date(t.createdAt).toLocaleDateString()} | ${t.revocable ? 'Revocable' : 'Irrevocable'}
                    </div>
                </div>
            `).join('');
        }

        // ==================== QCAD Stablecoin ====================
        const STABLECOIN_PALLET_INDEX = 23;
        const VAULT_STATUS = ['Active', 'AtRisk', 'Liquidatable', 'Liquidated', 'Closed'];

        // Local storage for vaults
        function saveVault(vault) {
            const vaults = JSON.parse(localStorage.getItem('qh_vaults') || '[]');
            const existingIdx = vaults.findIndex(v => v.id === vault.id);
            if (existingIdx >= 0) {
                vaults[existingIdx] = vault;
            } else {
                vaults.unshift(vault);
            }
            localStorage.setItem('qh_vaults', JSON.stringify(vaults));
        }

        function loadVaults() {
            return JSON.parse(localStorage.getItem('qh_vaults') || '[]');
        }

        // Update vault ratio preview
        function updateVaultRatioPreview() {
            const collateral = parseFloat(document.getElementById('vaultCollateral')?.value) || 0;
            const debt = parseFloat(document.getElementById('vaultDebt')?.value) || 0;
            const preview = document.getElementById('vaultRatioPreview');

            if (!preview) return;

            if (collateral > 0 && debt > 0) {
                const ratio = (collateral / debt) * 100;
                const ratioColor = ratio >= 150 ? 'var(--success)' : ratio >= 120 ? 'var(--warning)' : 'var(--danger)';
                const status = ratio >= 150 ? 'Healthy' : ratio >= 120 ? 'At Risk' : 'Below Minimum';
                preview.innerHTML = `<span style="color: ${ratioColor}; font-weight: bold;">${ratio.toFixed(1)}%</span> - ${status}`;
            } else {
                preview.textContent = 'Enter amounts above to see ratio';
            }
        }

        // Update open vault button state
        function updateVaultButton() {
            const btn = document.getElementById('openVaultBtn');
            if (!btn) return;

            const collateral = parseFloat(document.getElementById('vaultCollateral')?.value) || 0;
            const debt = parseFloat(document.getElementById('vaultDebt')?.value) || 0;
            const ratio = debt > 0 ? (collateral / debt) * 100 : 0;

            if (collateral <= 0 || debt < 100) {
                btn.disabled = true;
                btn.textContent = 'Enter Valid Amounts';
            } else if (ratio < 150) {
                btn.disabled = true;
                btn.textContent = 'Ratio Must Be >= 150%';
            } else if (!unlockedAccount) {
                btn.disabled = false;
                btn.textContent = 'Unlock Wallet to Open Vault';
            } else {
                btn.disabled = false;
                btn.textContent = 'Open Vault';
            }
        }

        // Update transfer QCAD button state
        function updateTransferQcadButton() {
            const btn = document.getElementById('transferQcadBtn');
            if (!btn) return;

            const recipient = document.getElementById('qcadRecipient')?.value?.trim() || '';
            const amount = parseFloat(document.getElementById('qcadAmount')?.value) || 0;

            if (!recipient || amount <= 0) {
                btn.disabled = true;
                btn.textContent = 'Enter Recipient & Amount';
            } else if (!unlockedAccount) {
                btn.disabled = false;
                btn.textContent = 'Unlock Wallet to Transfer';
            } else {
                btn.disabled = false;
                btn.textContent = 'Transfer QCAD';
            }
        }

        // Add event listeners to QCAD forms
        ['vaultCollateral', 'vaultDebt'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => {
                updateVaultRatioPreview();
                updateVaultButton();
            });
        });

        ['qcadRecipient', 'qcadAmount'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateTransferQcadButton);
        });

        // Open vault handler
        document.getElementById('openVaultBtn')?.addEventListener('click', async () => {
            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            const btn = document.getElementById('openVaultBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Opening Vault...';

            try {
                const collateralQMHY = parseFloat(document.getElementById('vaultCollateral').value);
                const debtQCAD = parseFloat(document.getElementById('vaultDebt').value);

                const ratio = (collateralQMHY / debtQCAD) * 100;
                if (ratio < 150) {
                    throw new Error('Collateral ratio must be at least 150%');
                }

                if (debtQCAD < 100) {
                    throw new Error('Minimum debt is 100 QCAD');
                }

                // Create vault locally
                const vault = {
                    id: Date.now(),
                    owner: unlockedAccount.address,
                    collateral: collateralQMHY,
                    debt: debtQCAD,
                    ratio: ratio,
                    status: 'Active',
                    createdAt: new Date().toISOString(),
                    onChainId: null,
                };

                saveVault(vault);
                renderMyVaults();

                showResult('vaultCreateResult', 'success', `
                    <strong>Vault Created Successfully</strong><br><br>
                    <strong>Collateral:</strong> ${collateralQMHY.toFixed(6)} QMHY<br>
                    <strong>QCAD Minted:</strong> ${debtQCAD.toFixed(2)} QCAD<br>
                    <strong>Ratio:</strong> ${ratio.toFixed(1)}%<br><br>
                    <span class="badge badge-warning">Note: On-chain submission requires pallet deployment</span>
                `);

                // Update QCAD balance
                updateQCADDisplay();

                // Clear form
                document.getElementById('vaultCollateral').value = '';
                document.getElementById('vaultDebt').value = '';
                updateVaultRatioPreview();

            } catch (e) {
                showResult('vaultCreateResult', 'error', `Error: ${e.message}`);
            }

            updateVaultButton();
        });

        // Transfer QCAD handler
        document.getElementById('transferQcadBtn')?.addEventListener('click', async () => {
            if (!unlockedAccount) {
                showAccountModal();
                return;
            }

            const btn = document.getElementById('transferQcadBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Transferring...';

            try {
                const recipient = document.getElementById('qcadRecipient').value.trim();
                const amount = parseFloat(document.getElementById('qcadAmount').value);

                if (!recipient || amount <= 0) {
                    throw new Error('Invalid recipient or amount');
                }

                showResult('transferQcadResult', 'success', `
                    <strong>Transfer Initiated</strong><br><br>
                    <strong>To:</strong> ${recipient.slice(0, 20)}...<br>
                    <strong>Amount:</strong> ${amount.toFixed(2)} QCAD<br><br>
                    <span class="badge badge-warning">Note: On-chain submission requires pallet deployment</span>
                `);

                // Clear form
                document.getElementById('qcadRecipient').value = '';
                document.getElementById('qcadAmount').value = '';

            } catch (e) {
                showResult('transferQcadResult', 'error', `Error: ${e.message}`);
            }

            updateTransferQcadButton();
        });

        function renderMyVaults() {
            const vaults = loadVaults();
            const container = document.getElementById('myVaults');

            if (!container) return;

            if (!vaults || vaults.length === 0) {
                container.innerHTML = '<p style="color: var(--muted); text-align: center; padding: 1rem;">No vaults yet. Open one above to start minting QCAD.</p>';
                return;
            }

            container.innerHTML = vaults.map(v => {
                const statusClass = v.status === 'Active' ? 'badge-success' :
                                   v.status === 'AtRisk' ? 'badge-warning' :
                                   v.status === 'Liquidated' ? 'badge-danger' : 'badge-info';
                const ratioColor = v.ratio >= 150 ? 'var(--success)' : v.ratio >= 120 ? 'var(--warning)' : 'var(--danger)';

                return `
                    <div class="account-item" style="flex-direction: column; align-items: flex-start; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <strong>Vault #${v.id.toString().slice(-6)}</strong>
                            <span class="badge ${statusClass}">${v.status}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; width: 100%; font-size: 0.9rem;">
                            <span><strong>Collateral:</strong> ${v.collateral.toFixed(4)} QMHY</span>
                            <span><strong>Debt:</strong> ${v.debt.toFixed(2)} QCAD</span>
                        </div>
                        <div style="font-size: 0.85rem;">
                            <strong>Ratio:</strong> <span style="color: ${ratioColor}; font-weight: bold;">${v.ratio.toFixed(1)}%</span>
                        </div>
                        <div style="font-size: 0.7rem; font-family: monospace; color: var(--muted);">
                            Created: ${new Date(v.createdAt).toLocaleDateString()}
                        </div>
                        ${v.status === 'Active' ? `
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="addCollateralPrompt(${v.id})">Add Collateral</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="repayDebtPrompt(${v.id})">Repay Debt</button>
                                <button class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;" onclick="closeVaultPrompt(${v.id})">Close</button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateQCADDisplay() {
            const vaults = loadVaults();
            const totalDebt = vaults.filter(v => v.status === 'Active').reduce((sum, v) => sum + v.debt, 0);

            const balanceEl = document.getElementById('qcadBalance');
            if (balanceEl) balanceEl.textContent = totalDebt.toFixed(2);

            const supplyEl = document.getElementById('totalQcadSupply');
            if (supplyEl) supplyEl.textContent = totalDebt.toFixed(2);
        }

        // Placeholder functions for vault actions
        function addCollateralPrompt(vaultId) {
            alert('Add Collateral - Coming with on-chain integration');
        }

        function repayDebtPrompt(vaultId) {
            alert('Repay Debt - Coming with on-chain integration');
        }

        function closeVaultPrompt(vaultId) {
            if (confirm('Close this vault? All debt must be repaid and collateral will be returned.')) {
                const vaults = loadVaults();
                const vault = vaults.find(v => v.id === vaultId);
                if (vault) {
                    vault.status = 'Closed';
                    saveVault(vault);
                    renderMyVaults();
                    updateQCADDisplay();
                }
            }
        }

        // ==================== Init ====================
        updateAccountUI();
        renderAttestationHistory();
        renderMyContracts();
        renderMyTrusts();
        renderMyVaults();
        updateQCADDisplay();
        updateVaultButton();
        updateTransferQcadButton();
        loadIPFSSettings();
        updateTrustButton();
    </script>
</body>
</html>
