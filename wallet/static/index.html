<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-sha3/0.8.0/sha3.min.js"></script>
    <script>
    // Blake2b-512 implementation for SS58 checksum
    var blakejs = (function() {
        // Blake2b constants
        var BLAKE2B_IV32 = new Uint32Array([
            0xF3BCC908, 0x6A09E667, 0x84CAA73B, 0xBB67AE85,
            0xFE94F82B, 0x3C6EF372, 0x5F1D36F1, 0xA54FF53A,
            0xADE682D1, 0x510E527F, 0x2B3E6C1F, 0x9B05688C,
            0xFB41BD6B, 0x1F83D9AB, 0x137E2179, 0x5BE0CD19
        ]);
        var SIGMA8 = [
            0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,
            14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3,
            11,8,12,0,5,2,15,13,10,14,3,6,7,1,9,4,
            7,9,3,1,13,12,11,14,2,6,5,10,4,0,15,8,
            9,0,5,7,2,4,10,15,14,1,11,12,6,8,3,13,
            2,12,6,10,0,11,8,3,4,13,7,5,15,14,1,9,
            12,5,1,15,14,13,4,10,0,7,6,3,9,2,8,11,
            13,11,7,14,12,1,3,9,5,0,15,4,8,6,2,10,
            6,15,14,9,11,3,0,8,12,2,13,7,1,4,10,5,
            10,2,8,4,7,6,1,5,15,11,9,14,3,12,13,0,
            0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,
            14,10,4,8,9,15,13,6,1,12,0,2,11,7,5,3
        ];
        
        function ADD64AA(v, a, b) {
            var o0 = v[a] + v[b];
            var o1 = v[a + 1] + v[b + 1];
            if (o0 >= 0x100000000) o1++;
            v[a] = o0; v[a + 1] = o1;
        }
        
        function ADD64AC(v, a, b0, b1) {
            var o0 = v[a] + b0;
            if (b0 < 0) o0 += 0x100000000;
            var o1 = v[a + 1] + b1;
            if (o0 >= 0x100000000) o1++;
            v[a] = o0; v[a + 1] = o1;
        }
        
        function B2B_GET32(arr, i) {
            return arr[i] ^ (arr[i+1]<<8) ^ (arr[i+2]<<16) ^ (arr[i+3]<<24);
        }
        
        function B2B_G(a, b, c, d, ix, iy, m, v) {
            var x0 = m[ix], x1 = m[ix + 1];
            var y0 = m[iy], y1 = m[iy + 1];
            ADD64AA(v, a, b);
            ADD64AC(v, a, x0, x1);
            var xor0 = v[d] ^ v[a], xor1 = v[d + 1] ^ v[a + 1];
            v[d] = xor1; v[d + 1] = xor0;
            ADD64AA(v, c, d);
            xor0 = v[b] ^ v[c]; xor1 = v[b + 1] ^ v[c + 1];
            v[b] = (xor0 >>> 24) ^ (xor1 << 8);
            v[b + 1] = (xor1 >>> 24) ^ (xor0 << 8);
            ADD64AA(v, a, b);
            ADD64AC(v, a, y0, y1);
            xor0 = v[d] ^ v[a]; xor1 = v[d + 1] ^ v[a + 1];
            v[d] = (xor0 >>> 16) ^ (xor1 << 16);
            v[d + 1] = (xor1 >>> 16) ^ (xor0 << 16);
            ADD64AA(v, c, d);
            xor0 = v[b] ^ v[c]; xor1 = v[b + 1] ^ v[c + 1];
            v[b] = (xor1 >>> 31) ^ (xor0 << 1);
            v[b + 1] = (xor0 >>> 31) ^ (xor1 << 1);
        }
        
        function blake2bCompress(ctx, last) {
            var i = 0;
            var v = new Uint32Array(32);
            var m = new Uint32Array(32);
            for (i = 0; i < 16; i++) {
                v[i] = ctx.h[i];
                v[i + 16] = BLAKE2B_IV32[i];
            }
            v[24] = v[24] ^ ctx.t;
            v[25] = v[25] ^ (ctx.t / 0x100000000);
            if (last) {
                v[28] = ~v[28];
                v[29] = ~v[29];
            }
            for (i = 0; i < 32; i++) {
                m[i] = B2B_GET32(ctx.b, 4 * i);
            }
            for (i = 0; i < 12; i++) {
                B2B_G(0, 8, 16, 24, SIGMA8[i*16+0]*2, SIGMA8[i*16+1]*2, m, v);
                B2B_G(2, 10, 18, 26, SIGMA8[i*16+2]*2, SIGMA8[i*16+3]*2, m, v);
                B2B_G(4, 12, 20, 28, SIGMA8[i*16+4]*2, SIGMA8[i*16+5]*2, m, v);
                B2B_G(6, 14, 22, 30, SIGMA8[i*16+6]*2, SIGMA8[i*16+7]*2, m, v);
                B2B_G(0, 10, 20, 30, SIGMA8[i*16+8]*2, SIGMA8[i*16+9]*2, m, v);
                B2B_G(2, 12, 22, 24, SIGMA8[i*16+10]*2, SIGMA8[i*16+11]*2, m, v);
                B2B_G(4, 14, 16, 26, SIGMA8[i*16+12]*2, SIGMA8[i*16+13]*2, m, v);
                B2B_G(6, 8, 18, 28, SIGMA8[i*16+14]*2, SIGMA8[i*16+15]*2, m, v);
            }
            for (i = 0; i < 16; i++) {
                ctx.h[i] = ctx.h[i] ^ v[i] ^ v[i + 16];
            }
        }
        
        function blake2bInit(outlen) {
            var ctx = {
                b: new Uint8Array(128),
                h: new Uint32Array(16),
                t: 0,
                c: 0,
                outlen: outlen
            };
            for (var i = 0; i < 16; i++) ctx.h[i] = BLAKE2B_IV32[i];
            ctx.h[0] ^= 0x01010000 ^ outlen;
            return ctx;
        }
        
        function blake2bUpdate(ctx, input) {
            for (var i = 0; i < input.length; i++) {
                if (ctx.c === 128) {
                    ctx.t += ctx.c;
                    blake2bCompress(ctx, false);
                    ctx.c = 0;
                }
                ctx.b[ctx.c++] = input[i];
            }
        }
        
        function blake2bFinal(ctx) {
            ctx.t += ctx.c;
            while (ctx.c < 128) ctx.b[ctx.c++] = 0;
            blake2bCompress(ctx, true);
            var out = new Uint8Array(ctx.outlen);
            for (var i = 0; i < ctx.outlen; i++) {
                out[i] = ctx.h[i >> 2] >> (8 * (i & 3));
            }
            return out;
        }
        
        function blake2b(input, key, outlen) {
            outlen = outlen || 64;
            var ctx = blake2bInit(outlen);
            blake2bUpdate(ctx, input);
            return blake2bFinal(ctx);
        }
        
        return { blake2b: blake2b };
    })();
    console.log('Crypto libs loaded - keccak_256:', typeof keccak_256, 'blakejs.blake2b:', typeof blakejs.blake2b);
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paraxiom QuantumHarmony Wallet</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@400;500;600;700&display=swap');

        :root {
            /* LCARS Classic with subtle cyberpunk accent */
            --lcars-orange: #ff9900;
            --lcars-orange-dim: #cc7a00;
            --lcars-tan: #cc9966;
            --lcars-tan-dim: #a67744;
            --lcars-lavender: #cc99cc;
            --lcars-blue: #9999ff;
            --lcars-blue-dim: #7777cc;
            --lcars-red: #cc6666;
            --lcars-purple: #9977aa;
            --neon-accent: #00ff88;
            --neon-accent-dim: #00cc6a;
            --neon-accent-glow: rgba(0, 255, 136, 0.3);
            --dark-bg: #000000;
            --dark-panel: #111111;
            --dark-content: #1a1a1a;
            --text-light: #ffcc99;
            --text-white: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--dark-bg);
            background-image:
                radial-gradient(ellipse at 20% 80%, rgba(255, 153, 0, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(153, 153, 255, 0.02) 0%, transparent 50%),
                linear-gradient(180deg, var(--dark-bg) 0%, var(--dark-panel) 100%);
            color: var(--lcars-orange);
            font-family: 'Rajdhani', 'Helvetica Neue', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Scanline overlay effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0, 0, 0, 0.1) 2px,
                rgba(0, 0, 0, 0.1) 4px
            );
            pointer-events: none;
            z-index: 1000;
        }

        /* Main LCARS Frame */
        .lcars-frame {
            display: grid;
            grid-template-columns: 160px 1fr;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
            gap: 4px;
            padding: 12px;
        }

        /* Top curved header bar */
        .lcars-header {
            grid-column: 1 / -1;
            display: flex;
            height: 70px;
            margin-bottom: 4px;
        }

        .lcars-header-cap-left {
            width: 160px;
            background: linear-gradient(135deg, var(--lcars-orange) 0%, var(--lcars-orange-dim) 100%);
            border-radius: 35px 0 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .lcars-header-cap-left span {
            font-family: 'Orbitron', monospace;
            font-size: 20px;
            font-weight: 800;
            color: var(--dark-bg);
        }

        .lcars-header-bar {
            flex-grow: 1;
            background: var(--dark-panel);
            display: flex;
            align-items: center;
            padding: 0 30px;
            border-top: 3px solid var(--lcars-tan);
            border-bottom: 3px solid var(--lcars-tan);
        }

        .lcars-header-title {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 700;
            color: var(--lcars-orange);
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .lcars-header-cap-right {
            width: 180px;
            background: linear-gradient(135deg, var(--lcars-lavender) 0%, var(--lcars-purple) 100%);
            border-radius: 0 35px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border: none;
        }

        .status-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--neon-accent);
            box-shadow: 0 0 15px var(--neon-accent), 0 0 30px var(--neon-accent-glow);
            animation: pulse-glow 2s infinite;
        }

        .status-dot.offline {
            background: var(--lcars-red);
            box-shadow: 0 0 15px var(--lcars-red);
            animation: none;
        }

        @keyframes pulse-glow {
            0%, 100% { opacity: 1; box-shadow: 0 0 15px var(--neon-accent), 0 0 30px var(--neon-accent-glow); }
            50% { opacity: 0.7; box-shadow: 0 0 8px var(--neon-accent), 0 0 15px var(--neon-accent-glow); }
        }

        /* Left sidebar with curved elements */
        .lcars-sidebar {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lcars-sidebar-top {
            background: linear-gradient(180deg, var(--lcars-tan) 0%, var(--lcars-tan-dim) 100%);
            height: 50px;
            border-radius: 0 0 0 25px;
            border: none;
        }

        .lcars-nav-btn {
            background: var(--lcars-blue);
            color: var(--dark-bg);
            padding: 14px 16px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            border: none;
            text-align: left;
            transition: all 0.2s ease;
            border-radius: 0 20px 20px 0;
            margin-right: 12px;
        }

        .lcars-nav-btn:hover {
            background: var(--lcars-lavender);
            color: var(--dark-bg);
        }
        .lcars-nav-btn.active {
            background: var(--lcars-orange);
            color: var(--dark-bg);
            font-weight: 700;
        }

        .lcars-nav-spacer {
            background: var(--lcars-tan-dim);
            height: 20px;
            border-radius: 0 10px 10px 0;
            margin-right: 12px;
            border: none;
        }

        .lcars-sidebar-bottom {
            background: linear-gradient(180deg, var(--lcars-lavender) 0%, var(--lcars-purple) 100%);
            flex-grow: 1;
            border-radius: 0 25px 0 0;
            margin-top: auto;
            min-height: 120px;
            border: none;
        }

        /* Main content area */
        .lcars-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .lcars-content-top {
            background: var(--lcars-tan);
            height: 30px;
            border-radius: 0 0 20px 0;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border: none;
        }

        .content-label {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: 600;
            color: var(--dark-bg);
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .lcars-content {
            background: var(--dark-content);
            flex-grow: 1;
            border-radius: 4px;
            padding: 25px;
            overflow-y: auto;
            border: 2px solid var(--lcars-tan-dim);
        }

        /* Footer */
        .lcars-footer {
            grid-column: 1 / -1;
            display: flex;
            height: 50px;
            margin-top: 4px;
        }

        .lcars-footer-cap-left {
            width: 160px;
            background: linear-gradient(135deg, var(--lcars-tan) 0%, var(--lcars-tan-dim) 100%);
            border-radius: 0 0 0 35px;
            border: none;
        }

        .lcars-footer-bar {
            flex-grow: 1;
            background: var(--dark-panel);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            border-top: 3px solid var(--lcars-tan);
            border-bottom: 3px solid var(--lcars-tan);
        }

        .footer-info {
            font-family: 'Orbitron', monospace;
            font-size: 11px;
            font-weight: 500;
            color: var(--lcars-tan);
            letter-spacing: 2px;
        }

        .lcars-footer-cap-right {
            width: 180px;
            background: linear-gradient(135deg, var(--lcars-blue) 0%, var(--lcars-blue-dim) 100%);
            border-radius: 0 0 35px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
        }

        .footer-info span {
            color: var(--neon-accent);
        }

        /* Panels */
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }

        .panel-header {
            font-family: 'Orbitron', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--lcars-orange);
            margin-bottom: 25px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--lcars-tan-dim);
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--dark-panel);
            padding: 18px;
            border-radius: 8px;
            border-left: 4px solid var(--lcars-blue);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            border-left-color: var(--lcars-orange);
        }

        .stat-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 600;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-family: 'Orbitron', monospace;
            font-size: 26px;
            font-weight: 700;
            color: var(--lcars-orange);
        }

        .stat-value.cyan { color: var(--lcars-blue); }

        /* Buttons */
        .lcars-btn {
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .lcars-btn.green {
            background: linear-gradient(135deg, var(--lcars-orange) 0%, var(--lcars-orange-dim) 100%);
            color: var(--dark-bg);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.3);
        }

        .lcars-btn.green:hover {
            background: linear-gradient(135deg, #ffaa33 0%, var(--lcars-orange) 100%);
            box-shadow: 0 0 25px rgba(255, 153, 0, 0.5);
            transform: translateY(-2px);
        }

        .lcars-btn.cyan {
            background: linear-gradient(135deg, var(--lcars-blue) 0%, var(--lcars-blue-dim) 100%);
            color: var(--dark-bg);
            box-shadow: 0 0 15px rgba(153, 153, 255, 0.3);
        }

        .lcars-btn.cyan:hover {
            box-shadow: 0 0 25px rgba(153, 153, 255, 0.5);
            transform: translateY(-2px);
        }

        .lcars-btn.gray {
            background: linear-gradient(135deg, var(--lcars-tan) 0%, var(--lcars-tan-dim) 100%);
            color: var(--dark-bg);
            border: none;
        }

        .lcars-btn.gray:hover {
            background: linear-gradient(135deg, var(--lcars-lavender) 0%, var(--lcars-tan) 100%);
            box-shadow: 0 0 15px rgba(204, 153, 102, 0.3);
        }

        .lcars-btn.red {
            background: linear-gradient(135deg, var(--lcars-red) 0%, #aa4444 100%);
            color: white;
            box-shadow: 0 0 15px rgba(204, 102, 102, 0.3);
        }

        .lcars-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
            display: block;
        }

        .lcars-input {
            width: 100%;
            padding: 14px 18px;
            background: var(--dark-panel);
            border: 1px solid var(--lcars-tan-dim);
            border-radius: 6px;
            color: var(--lcars-orange);
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .lcars-input:focus {
            outline: none;
            border-color: var(--lcars-orange);
            box-shadow: 0 0 15px rgba(255, 153, 0, 0.3);
        }

        .lcars-input::placeholder {
            color: var(--lcars-tan-dim);
        }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 6px;
            margin: 12px 0;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .alert.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--neon-accent);
            color: var(--neon-accent);
            box-shadow: 0 0 10px var(--neon-accent-glow);
        }

        .alert.error {
            background: rgba(204, 102, 102, 0.15);
            border: 1px solid var(--lcars-red);
            color: var(--lcars-red);
        }

        .alert.info {
            background: rgba(153, 153, 255, 0.1);
            border: 1px solid var(--lcars-blue);
            color: var(--lcars-blue);
        }

        /* Info rows */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--lcars-tan-dim);
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 2px;
            min-width: 120px;
        }

        .info-value {
            font-family: 'Rajdhani', monospace;
            font-size: 14px;
            font-weight: 500;
            color: var(--lcars-orange);
            word-break: break-all;
            flex: 1;
            text-align: right;
        }

        /* Account section */
        .account-info {
            background: linear-gradient(135deg, var(--dark-panel) 0%, var(--dark-content) 100%);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border: 1px solid var(--lcars-tan-dim);
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .account-header h3 {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--lcars-blue);
            letter-spacing: 2px;
        }

        .balance-display {
            text-align: center;
            padding: 25px;
            background: linear-gradient(135deg, var(--dark-panel) 0%, var(--dark-content) 100%);
            border-radius: 8px;
            border: 1px solid var(--lcars-tan-dim);
            margin-bottom: 20px;
        }

        .balance-label {
            font-family: 'Rajdhani', sans-serif;
            font-size: 13px;
            font-weight: 600;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .balance-value {
            font-family: 'Orbitron', monospace;
            font-size: 42px;
            font-weight: 800;
            color: var(--lcars-orange);
            text-shadow: 0 0 20px rgba(255, 153, 0, 0.4);
        }

        .balance-unit {
            font-size: 18px;
            color: var(--lcars-tan);
            margin-left: 8px;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--lcars-tan);
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 14px;
            text-align: left;
            border-bottom: 2px solid var(--lcars-tan-dim);
        }

        .data-table td {
            padding: 14px;
            border-bottom: 1px solid var(--lcars-tan-dim);
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 500;
            color: var(--lcars-orange);
        }

        .data-table tr:hover {
            background: rgba(255, 153, 0, 0.05);
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--dark-panel);
            border-top-color: var(--lcars-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Section dividers */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--lcars-orange), transparent);
            margin: 30px 0;
            opacity: 0.5;
        }

        /* Section title */
        .section-title {
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 600;
            color: var(--lcars-blue);
            letter-spacing: 3px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }

        /* Button group */
        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .lcars-frame {
                grid-template-columns: 1fr;
            }
            .lcars-sidebar {
                display: none;
            }
            .lcars-header-cap-left,
            .lcars-footer-cap-left {
                width: 100px;
            }
            .balance-value {
                font-size: 28px;
            }
        }

        /* Key display */
        .key-display {
            background: var(--dark-panel);
            padding: 12px;
            border-radius: 6px;
            border: 1px solid var(--lcars-tan-dim);
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            margin: 8px 0;
        }

        .key-display.private {
            color: var(--lcars-orange);
            border-color: var(--lcars-orange);
            background: rgba(255, 153, 0, 0.1);
        }

        .key-display.public {
            color: var(--lcars-blue);
        }
    </style>
</head>
<body>
    <div class="lcars-frame">
        <!-- Header -->
        <div class="lcars-header">
            <div class="lcars-header-cap-left" style="display: flex; align-items: center; justify-content: center; padding: 5px;">
                <img src="paraxiom-logo.png" alt="Paraxiom" style="height: 50px; filter: drop-shadow(0 0 8px rgba(255,153,0,0.5));">
            </div>
            <div class="lcars-header-bar">
                <div class="lcars-header-title">QuantumHarmony</div>
            </div>
            <div class="lcars-header-cap-right">
                <div class="status-dot" id="statusDot"></div>
                <span style="font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 600; color: var(--neon-green);" id="connStatus">ONLINE</span>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lcars-sidebar">
            <div class="lcars-sidebar-top"></div>
            <button class="lcars-nav-btn active" onclick="showPanel('status')">STATUS</button>
            <button class="lcars-nav-btn" onclick="showPanel('wallet')">WALLET</button>
            <button class="lcars-nav-btn" onclick="showPanel('send')">TRANSFER</button>
            <button class="lcars-nav-btn" onclick="showPanel('faucet')">FAUCET</button>
            <button class="lcars-nav-btn" onclick="showPanel('govern')">GOVERN</button>
            <button class="lcars-nav-btn" onclick="showPanel('rewards')">REWARDS</button>
            <button class="lcars-nav-btn" onclick="showPanel('runtime')">RUNTIME</button>
            <button class="lcars-nav-btn" onclick="showPanel('keys')">KEYS</button>
            <button class="lcars-nav-btn" onclick="showPanel('quantum')">QUANTUM</button>
            <div class="lcars-nav-spacer"></div>
            <button class="lcars-nav-btn" onclick="showPanel('network')">NETWORK</button>
            <div class="lcars-sidebar-bottom"></div>
        </div>

        <!-- Main Content -->
        <div class="lcars-main">
            <div class="lcars-content-top">
                <span class="content-label">SYSTEM INTERFACE v2.1.0</span>
            </div>
            <div class="lcars-content">
                <!-- Status Panel -->
                <div id="panel-status" class="panel active">
                    <h2 class="panel-header">Node Status</h2>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Block Height</div>
                            <div class="stat-value" id="blockHeight">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Peers</div>
                            <div class="stat-value cyan" id="peerCount">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Chain</div>
                            <div class="stat-value" id="chainName" style="font-size: 16px;">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Sync Status</div>
                            <div class="stat-value" id="syncStatus">---</div>
                        </div>
                    </div>

                    <div class="section-title">Recent Activity</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Block</th>
                                <th>Hash</th>
                                <th>Extrinsics</th>
                            </tr>
                        </thead>
                        <tbody id="recentBlocks">
                            <tr><td colspan="3" style="text-align: center; color: var(--light-gray);">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Wallet Panel -->
                <div id="panel-wallet" class="panel">
                    <h2 class="panel-header">Wallet</h2>

                    <div class="account-info" id="accountSection" style="display: none;">
                        <div class="account-header">
                            <h3>Active Account</h3>
                            <button class="lcars-btn gray" onclick="getBalance()">Refresh Balance</button>
                        </div>
                        <div class="balance-display">
                            <div class="balance-label">Available Balance</div>
                            <div class="balance-value"><span id="balance">0</span><span class="balance-unit">QMHY</span></div>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address</span>
                            <span class="info-value" id="accountAddr">---</span>
                        </div>
                    </div>

                    <div id="noAccountSection">
                        <div class="alert info">No account loaded. Create a new account or import an existing one.</div>
                    </div>

                    <div class="section-divider"></div>

                    <div class="section-title">Create New Account</div>
                    <p style="color: var(--light-gray); margin-bottom: 15px; font-size: 14px;">Generate a new SPHINCS+ quantum-resistant keypair.</p>
                    <button class="lcars-btn green" onclick="createAccount()">Generate Account</button>
                    <div id="newAccountResult" style="margin-top: 15px;"></div>

                    <div class="section-divider"></div>

                    <div class="section-title">Import Account</div>
                    <div class="input-group">
                        <label class="input-label">Private Key (Hex)</label>
                        <input type="password" class="lcars-input" id="importKey" placeholder="0x...">
                    </div>
                    <button class="lcars-btn cyan" onclick="importAccount()">Import</button>
                    <select class="lcars-btn orange" onchange="if(this.value) loadTestAccount(this.value)" style="margin-left: 10px; padding: 8px;">
                        <option value="">Select Test Account</option>
                        <option value="Alice">Alice (Funded)</option>
                        <option value="Bob">Bob</option>
                        <option value="Charlie">Charlie</option>
                    </select>
                    <div id="importResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Send Panel -->
                <div id="panel-send" class="panel">
                    <h2 class="panel-header">Transfer Tokens</h2>

                    <div class="input-group">
                        <label class="input-label">Recipient Address</label>
                        <input type="text" class="lcars-input" id="sendTo" placeholder="5...">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Amount (QMHY)</label>
                        <input type="number" class="lcars-input" id="sendAmount" placeholder="0.00" step="0.01">
                    </div>
                    <button class="lcars-btn green" onclick="sendTokens()">Execute Transfer</button>
                    <div id="sendResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Faucet Panel -->
                <div id="panel-faucet" class="panel">
                    <h2 class="panel-header">Testnet Faucet</h2>

                    <div class="alert info" style="margin-bottom: 20px;">
                        Request testnet QMHY tokens. Limited to 10 QMHY per request.
                    </div>

                    <div class="input-group">
                        <label class="input-label">Recipient Address</label>
                        <input type="text" class="lcars-input" id="faucetAddr" placeholder="5...">
                    </div>
                    <button class="lcars-btn cyan" onclick="requestFaucet()">Request Tokens</button>
                    <div id="faucetResult" style="margin-top: 15px;"></div>
                </div>

                <!-- Govern Panel -->
                <div id="panel-govern" class="panel">
                    <h2 class="panel-header">On-Chain Governance</h2>

                    <div class="section-title">Active Proposals</div>
                    <div id="activeProposals" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Loading proposals...</div>
                        </div>
                    </div>

                    <div class="section-title">Create Proposal</div>
                    <div class="input-group">
                        <label class="input-label">Proposal Title</label>
                        <input type="text" class="lcars-input" id="proposalTitle" placeholder="Enter proposal title">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Description</label>
                        <textarea class="lcars-input" id="proposalDesc" rows="3" placeholder="Describe your proposal"></textarea>
                    </div>
                    <button class="lcars-btn cyan" onclick="submitProposal()">Submit Proposal</button>

                    <div class="section-divider"></div>
                    <div class="section-title">Voting Power</div>
                    <div class="info-row">
                        <span class="info-label">Your Voting Power</span>
                        <span class="info-value" id="votingPower">---</span>
                    </div>
                </div>

                <!-- Rewards Panel -->
                <div id="panel-rewards" class="panel">
                    <h2 class="panel-header">Staking Rewards</h2>

                    <div class="stat-grid" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Total Staked</div>
                            <div class="stat-value" id="totalStaked">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Claimable Rewards</div>
                            <div class="stat-value" id="claimableRewards">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">APY</div>
                            <div class="stat-value" id="stakingApy">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Era Progress</div>
                            <div class="stat-value" id="eraProgress">---</div>
                        </div>
                    </div>

                    <button class="lcars-btn green" onclick="claimRewards()">Claim Rewards</button>

                    <div class="section-divider"></div>
                    <div class="section-title">Reward History</div>
                    <table class="data-table">
                        <thead>
                            <tr><th>Era</th><th>Amount</th><th>Status</th></tr>
                        </thead>
                        <tbody id="rewardHistory">
                            <tr><td colspan="3" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Runtime Panel -->
                <div id="panel-runtime" class="panel">
                    <h2 class="panel-header">Runtime Upgrades</h2>

                    <div class="section-title">Current Runtime</div>
                    <div class="info-row">
                        <span class="info-label">Spec Version</span>
                        <span class="info-value" id="specVersion">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Impl Version</span>
                        <span class="info-value" id="implVersion">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Runtime Name</span>
                        <span class="info-value" id="runtimeName">---</span>
                    </div>

                    <div class="section-divider"></div>
                    <div class="section-title">Pending Upgrades</div>
                    <div id="pendingUpgrades">
                        <div class="alert info">No pending runtime upgrades</div>
                    </div>

                    <div class="section-divider"></div>
                    <div class="section-title">Test Runtime Upgrade</div>
                    <div class="input-group">
                        <label class="input-label">WASM File</label>
                        <input type="file" class="lcars-input" id="wasmFile" accept=".wasm">
                    </div>
                    <button class="lcars-btn cyan" onclick="testRuntimeUpgrade()">Test Upgrade (Dry Run)</button>
                </div>

                <!-- Keys Panel -->
                <div id="panel-keys" class="panel">
                    <h2 class="panel-header">Key Management</h2>

                    <div class="section-title">Session Keys</div>
                    <div class="info-row">
                        <span class="info-label">GRANDPA</span>
                        <span class="info-value" id="grandpaKey" style="font-size: 11px;">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">BABE</span>
                        <span class="info-value" id="babeKey" style="font-size: 11px;">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">IM Online</span>
                        <span class="info-value" id="imonlineKey" style="font-size: 11px;">---</span>
                    </div>

                    <div class="section-divider"></div>
                    <button class="lcars-btn green" onclick="rotateSessionKeys()">Rotate Session Keys</button>
                    <button class="lcars-btn cyan" onclick="exportKeys()">Export Keys</button>

                    <div class="section-divider"></div>
                    <div class="section-title">Inject Keys</div>
                    <div class="input-group">
                        <label class="input-label">Key Type</label>
                        <select class="lcars-input" id="keyType">
                            <option value="gran">GRANDPA (gran)</option>
                            <option value="babe">BABE (babe)</option>
                            <option value="imon">IM Online (imon)</option>
                            <option value="aura">AURA (aura)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Seed Phrase</label>
                        <input type="password" class="lcars-input" id="keySeed" placeholder="Enter seed phrase">
                    </div>
                    <button class="lcars-btn orange" onclick="injectKey()">Inject Key</button>
                </div>

                <!-- Quantum Panel -->
                <div id="panel-quantum" class="panel">
                    <h2 class="panel-header">Quantum Devices</h2>

                    <div class="section-title">Connected QRNG Devices</div>
                    <div id="qrngDevices" style="margin-bottom: 20px;">
                        <div class="stat-card">
                            <div class="stat-label">Loading devices...</div>
                        </div>
                    </div>

                    <div class="stat-grid">
                        <div class="stat-card">
                            <div class="stat-label">Entropy Pool</div>
                            <div class="stat-value" id="entropyPool">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg QBER</div>
                            <div class="stat-value" id="avgQber">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">QKD Channels</div>
                            <div class="stat-value" id="qkdChannels">---</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">SPHINCS+ Status</div>
                            <div class="stat-value" id="sphincsStatus">---</div>
                        </div>
                    </div>

                    <div class="section-divider"></div>
                    <div class="section-title">PQC Security Level</div>
                    <div class="alert info">NIST Level 3 - Post-Quantum Secure</div>

                    <div class="section-divider"></div>
                    <button class="lcars-btn green" onclick="refreshQuantumStatus()">Refresh Status</button>
                    <button class="lcars-btn cyan" onclick="getQuantumRandom()">Get Random Bytes</button>
                </div>

                <!-- Network Panel -->
                <div id="panel-network" class="panel">
                    <h2 class="panel-header">Network Topology</h2>

                    <div class="section-title">Toroidal Mesh Network</div>
                    <div style="background: #0a0a14; border-radius: 8px; padding: 10px; margin-bottom: 20px;">
                        <canvas id="networkCanvas" width="500" height="300" style="width: 100%; max-width: 500px; display: block; margin: 0 auto;"></canvas>
                    </div>

                    <div class="section-title">Validator Nodes</div>
                    <div id="validatorNodes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
                    </div>

                    <div class="section-title">Connected Peers</div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Peer ID</th>
                                <th>Role</th>
                                <th>Best Block</th>
                            </tr>
                        </thead>
                        <tbody id="peerList">
                            <tr><td colspan="3" style="text-align: center; color: var(--light-gray);">Loading peers...</td></tr>
                        </tbody>
                    </table>

                    <div class="section-divider"></div>

                    <div class="section-title">Node Information</div>
                    <div class="info-row">
                        <span class="info-label">Node Name</span>
                        <span class="info-value" id="nodeName">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Version</span>
                        <span class="info-value" id="nodeVersion">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Network Health</span>
                        <span class="info-value" id="networkHealth" style="color: var(--neon-green);">---</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="lcars-footer">
            <div class="lcars-footer-cap-left"></div>
            <div class="lcars-footer-bar">
                <span class="footer-info" id="timestamp">---</span>
            </div>
            <div class="lcars-footer-cap-right">
                <span style="font-family: 'Orbitron', monospace; font-size: 10px; font-weight: 600; color: var(--neon-green);">PARAXIOM</span>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const RPC = 'http://localhost:9944';
        const FAUCET = 'http://localhost:8081';

        // State
        let account = null;
        let privateKey = null;
        let connected = false;

        // RPC helper - returns { result, error } for proper error handling
        async function rpc(method, params = []) {
            try {
                const res = await fetch(RPC, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ jsonrpc: '2.0', id: 1, method, params })
                });
                const data = await res.json();
                if (data.error) {
                    console.error('RPC error:', data.error);
                    return { result: null, error: data.error };
                }
                return { result: data.result, error: null };
            } catch (e) {
                console.error('RPC error:', e);
                return { result: null, error: { message: e.message || 'Network error' } };
            }
        }

        // Simple RPC helper for backward compatibility (returns just result)
        async function rpcResult(method, params = []) {
            const { result } = await rpc(method, params);
            return result;
        }

        // Copy to clipboard helper
        function copyToClipboard(btn) {
            const text = btn.getAttribute('data-copy');
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'COPIED!';
                btn.style.background = 'var(--neon-accent)';
                btn.style.color = '#000';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            }).catch(err => {
                console.error('Copy failed:', err);
                btn.textContent = 'FAILED';
                setTimeout(() => btn.textContent = btn.getAttribute('data-original') || 'Copy', 2000);
            });
        }

        // Panel navigation
        function showPanel(name) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.lcars-nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('panel-' + name).classList.add('active');
            event.target.classList.add('active');
        }

        // Update status
        async function updateStatus() {
            const health = (await rpc('system_health')).result;
            const header = (await rpc('chain_getHeader')).result;
            const chain = (await rpc('system_chain')).result;
            const name = (await rpc('system_name')).result;
            const version = (await rpc('system_version')).result;
            const roles = (await rpc('system_nodeRoles')).result;

            connected = health !== null;
            document.getElementById('statusDot').className = 'status-dot' + (connected ? '' : ' offline');
            document.getElementById('connStatus').textContent = connected ? 'ONLINE' : 'OFFLINE';

            if (health) {
                document.getElementById('peerCount').textContent = health.peers || 0;
                document.getElementById('syncStatus').textContent = health.isSyncing ? 'SYNCING' : 'SYNCED';
            }

            if (header) {
                document.getElementById('blockHeight').textContent = parseInt(header.number, 16).toLocaleString();
            }

            if (chain) document.getElementById('chainName').textContent = chain;
            if (name) document.getElementById('nodeName').textContent = name;
            if (version) document.getElementById('nodeVersion').textContent = version;
            if (roles) document.getElementById('nodeRoles').textContent = roles.join(', ');

            document.getElementById('timestamp').textContent = new Date().toLocaleTimeString();
        }

        // Update recent blocks
        async function updateRecentBlocks() {
            const header = (await rpc('chain_getHeader')).result;
            if (!header) return;

            const currentBlock = parseInt(header.number, 16);
            let html = '';

            for (let i = 0; i < 5 && currentBlock - i > 0; i++) {
                const blockNum = currentBlock - i;
                const hashResp = await rpc('chain_getBlockHash', [blockNum]); const hash = hashResp.result;
                if (hash) {
                    html += `<tr>
                        <td>#${blockNum.toLocaleString()}</td>
                        <td style="font-size: 11px;">${hash.slice(0, 18)}...${hash.slice(-8)}</td>
                        <td>-</td>
                    </tr>`;
                }
            }

            document.getElementById('recentBlocks').innerHTML = html || '<tr><td colspan="3">No blocks</td></tr>';
        }

        // Base58 alphabet (Bitcoin/Substrate standard)
        const BASE58_ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';

        // Simple Blake2b-512 implementation for SS58 checksum
        // This uses the SubtleCrypto API as a fallback since we can't use Blake2b directly
        // For SS58, we use a simplified checksum approach
        function ss58Checksum(data) {
            // SS58 checksum prefix
            const SS58_PREFIX = new Uint8Array([0x53, 0x53, 0x35, 0x38, 0x50, 0x52, 0x45]); // "SS58PRE"

            // Concatenate prefix + data
            const input = new Uint8Array(SS58_PREFIX.length + data.length);
            input.set(SS58_PREFIX);
            input.set(data, SS58_PREFIX.length);

            // Use blakejs library if available (proper Blake2b-512)
            if (typeof blakejs !== "undefined" && typeof blakejs.blake2b !== "undefined") {
                return blakejs.blake2b(input, null, 64);
            }

            // Simple hash using available crypto (not true Blake2b, but works for demo)
            // In production, use a proper Blake2b library
            let hash = new Uint8Array(64);
            for (let i = 0; i < input.length; i++) {
                hash[i % 64] ^= input[i];
                hash[(i + 1) % 64] = (hash[(i + 1) % 64] + input[i]) & 0xff;
                hash[(i + 7) % 64] = (hash[(i + 7) % 64] ^ (input[i] << 3)) & 0xff;
            }
            // Additional mixing
            for (let round = 0; round < 12; round++) {
                for (let i = 0; i < 64; i++) {
                    hash[i] = (hash[i] + hash[(i + 1) % 64] + hash[(i + 31) % 64]) & 0xff;
                }
            }
            return hash;
        }

        // Base58 encode
        function base58Encode(bytes) {
            const digits = [0];
            for (let i = 0; i < bytes.length; i++) {
                let carry = bytes[i];
                for (let j = 0; j < digits.length; j++) {
                    carry += digits[j] << 8;
                    digits[j] = carry % 58;
                    carry = Math.floor(carry / 58);
                }
                while (carry > 0) {
                    digits.push(carry % 58);
                    carry = Math.floor(carry / 58);
                }
            }
            // Handle leading zeros
            let result = '';
            for (let i = 0; i < bytes.length && bytes[i] === 0; i++) {
                result += BASE58_ALPHABET[0];
            }
            // Convert digits to string (reverse order)
            for (let i = digits.length - 1; i >= 0; i--) {
                result += BASE58_ALPHABET[digits[i]];
            }
            return result;
        }

        // Generate SS58 address from 32-byte account ID
        function toSS58(accountId, prefix = 42) {
            // For prefix < 64, it's a single byte
            // For prefix >= 64, it's two bytes (not needed for prefix 42)
            const prefixBytes = prefix < 64 ? [prefix] : [
                ((prefix & 0xfc) >> 2) | 0x40,
                (prefix >> 8) | ((prefix & 0x03) << 6)
            ];

            // Construct payload: prefix + accountId
            const payload = new Uint8Array(prefixBytes.length + accountId.length);
            for (let i = 0; i < prefixBytes.length; i++) {
                payload[i] = prefixBytes[i];
            }
            payload.set(accountId, prefixBytes.length);

            // Calculate checksum
            const hash = ss58Checksum(payload);
            const checksumLength = prefix < 64 ? 2 : 2;

            // Final address: payload + checksum[0:checksumLength]
            const address = new Uint8Array(payload.length + checksumLength);
            address.set(payload);
            address.set(hash.slice(0, checksumLength), payload.length);

            return base58Encode(address);
        }

        // Keccak-256 implementation for account derivation (matches Rust's sp_io::hashing::keccak_256)
        const KECCAK_ROUNDS = 24;
        const RC = new BigUint64Array([
            0x0000000000000001n, 0x0000000000008082n, 0x800000000000808an,
            0x8000000080008000n, 0x000000000000808bn, 0x0000000080000001n,
            0x8000000080008081n, 0x8000000000008009n, 0x000000000000008an,
            0x0000000000000088n, 0x0000000080008009n, 0x000000008000000an,
            0x000000008000808bn, 0x800000000000008bn, 0x8000000000008089n,
            0x8000000000008003n, 0x8000000000008002n, 0x8000000000000080n,
            0x000000000000800an, 0x800000008000000an, 0x8000000080008081n,
            0x8000000000008080n, 0x0000000080000001n, 0x8000000080008008n
        ]);
        const ROTC = [1, 3, 6, 10, 15, 21, 28, 36, 45, 55, 2, 14, 27, 41, 56, 8, 25, 43, 62, 18, 39, 61, 20, 44];
        const PILN = [10, 7, 11, 17, 18, 3, 5, 16, 8, 21, 24, 4, 15, 23, 19, 13, 12, 2, 20, 14, 22, 9, 6, 1];

        function rotl64(x, n) {
            n = BigInt(n);
            return ((x << n) | (x >> (64n - n))) & 0xFFFFFFFFFFFFFFFFn;
        }

        function keccakF(state) {
            const bc = new BigUint64Array(5);
            for (let round = 0; round < KECCAK_ROUNDS; round++) {
                for (let i = 0; i < 5; i++) {
                    bc[i] = state[i] ^ state[i + 5] ^ state[i + 10] ^ state[i + 15] ^ state[i + 20];
                }
                for (let i = 0; i < 5; i++) {
                    const t = bc[(i + 4) % 5] ^ rotl64(bc[(i + 1) % 5], 1);
                    for (let j = 0; j < 25; j += 5) { state[j + i] ^= t; }
                }
                let t = state[1];
                for (let i = 0; i < 24; i++) {
                    const j = PILN[i];
                    bc[0] = state[j];
                    state[j] = rotl64(t, ROTC[i]);
                    t = bc[0];
                }
                for (let j = 0; j < 25; j += 5) {
                    for (let i = 0; i < 5; i++) { bc[i] = state[j + i]; }
                    for (let i = 0; i < 5; i++) { state[j + i] ^= (~bc[(i + 1) % 5]) & bc[(i + 2) % 5]; }
                }
                state[0] ^= RC[round];
            }
        }

        function keccak256(input) {
            // Use js-sha3 library
            if (typeof keccak_256 !== "undefined" && keccak_256 && typeof keccak_256.array === "function") {
                if (!(input instanceof Uint8Array)) {
                    input = typeof input === "string" ? new TextEncoder().encode(input) : new Uint8Array(input);
                }
                var result = new Uint8Array(keccak_256.array(input));
                console.log('keccak256 input length:', input.length, 'output:', Array.from(result.slice(0,8)).map(b => b.toString(16).padStart(2,'0')).join('') + '...');
                return result;
            }
            console.warn('keccak256: using FALLBACK implementation!');
            // Fallback to original implementation
            const rate = 136;
            if (!(input instanceof Uint8Array)) {
                input = typeof input === 'string' ? new TextEncoder().encode(input) : new Uint8Array(input);
            }
            const state = new BigUint64Array(25);
            let offset = 0;
            while (offset < input.length) {
                const blockSize = Math.min(rate, input.length - offset);
                for (let i = 0; i < blockSize; i++) {
                    const stateIdx = Math.floor(i / 8);
                    const byteIdx = BigInt(i % 8);
                    state[stateIdx] ^= BigInt(input[offset + i]) << (byteIdx * 8n);
                }
                offset += blockSize;
                if (blockSize === rate || offset === input.length) {
                    if (offset === input.length) {
                        const padStart = (input.length % rate);
                        const padStateIdx = Math.floor(padStart / 8);
                        const padByteIdx = BigInt(padStart % 8);
                        state[padStateIdx] ^= 0x01n << (padByteIdx * 8n);
                        const lastIdx = Math.floor((rate - 1) / 8);
                        const lastByteIdx = BigInt((rate - 1) % 8);
                        state[lastIdx] ^= 0x80n << (lastByteIdx * 8n);
                    }
                    keccakF(state);
                }
            }
            if (input.length === 0 || input.length % rate === 0) {
                state[0] ^= 0x01n;
                state[Math.floor((rate - 1) / 8)] ^= 0x80n << (BigInt((rate - 1) % 8) * 8n);
                keccakF(state);
            }
            const output = new Uint8Array(32);
            for (let i = 0; i < 32; i++) {
                const stateIdx = Math.floor(i / 8);
                const byteIdx = i % 8;
                output[i] = Number((state[stateIdx] >> BigInt(byteIdx * 8)) & 0xFFn);
            }
            return output;
        }

        // Create account
        function createAccount() {
            // Simulate SPHINCS+ key generation
            // SPHINCS+ secret key is 128 bytes: first 64 = private seed, last 64 = public key
            const privBytes = new Uint8Array(128);
            crypto.getRandomValues(privBytes);
            
            // Public key is the LAST 64 bytes of the secret key
            const pubBytes = privBytes.slice(64);

            const pubHex = '0x' + Array.from(pubBytes).map(b => b.toString(16).padStart(2, '0')).join('');
            const privHex = '0x' + Array.from(privBytes).map(b => b.toString(16).padStart(2, '0')).join('');
            
            console.log('Generated key - pubKey last 8 bytes:', Array.from(pubBytes.slice(-8)).map(b => b.toString(16).padStart(2,'0')).join(''));
            console.log('Generated key - privKey last 8 bytes:', Array.from(privBytes.slice(-8)).map(b => b.toString(16).padStart(2,'0')).join(''));

            // Generate 32-byte account ID from 64-byte public key using Keccak-256
            // This matches the Rust implementation: sp_io::hashing::keccak_256(&public_key)[..32]
            const accountId = keccak256(pubBytes);

            // Generate proper SS58 address with prefix 42 (generic Substrate)
            const addr = toSS58(accountId, 42);

            account = { address: addr, publicKey: pubHex };
            privateKey = privHex;

            document.getElementById('newAccountResult').innerHTML = `
                <div class="alert warning">WARNING: Generated accounts use random keys that won't work for transfers. Use Test Accounts instead!</div>
                <div class="info-row">
                    <span class="info-label">Address</span>
                    <span class="info-value">${addr}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Public Key</span>
                </div>
                <div class="key-display public">${pubHex}</div>
                <div class="info-row">
                    <span class="info-label">Private Key</span>
                </div>
                <div class="key-display private">${privHex}</div>
                <div class="alert info" style="margin-top: 15px;">
                    <strong>CRITICAL:</strong> Save your private key securely! It will not be shown again.
                </div>
                <div class="btn-group">
                    <button class="lcars-btn gray" data-copy="${privHex}" onclick="copyToClipboard(this)">Copy Private Key</button>
                    <button class="lcars-btn gray" data-copy="${addr}" onclick="copyToClipboard(this)">Copy Address</button>
                </div>
            `;

            updateAccountDisplay();
        }

        // Import account
        function importAccount() {
            const key = document.getElementById('importKey').value.trim();
            if (!key || key.length < 10) {
                document.getElementById('importResult').innerHTML = '<div class="alert error">Invalid private key format</div>';
                return;
            }

            // For SPHINCS+-256s, the 128-byte secret key structure is:
            // [64-byte seed + 64-byte public key]
            // The public key is the LAST 64 bytes, not the first!
            const pubBytes = new Uint8Array(64);
            const keyBytes = key.replace('0x', '');

            // Validate key length (must be 256 hex chars = 128 bytes)
            if (keyBytes.length !== 256) {
                document.getElementById('importResult').innerHTML = '<div class="alert error">Invalid key length. SPHINCS+ secret key must be 128 bytes (256 hex chars)</div>';
                return;
            }

            // Extract public key from the LAST 64 bytes (chars 128-256)
            for (let i = 0; i < 64; i++) {
                pubBytes[i] = parseInt(keyBytes.substr(128 + i * 2, 2), 16) || 0;
            }

            const pubHex = '0x' + Array.from(pubBytes).map(b => b.toString(16).padStart(2, '0')).join('');

            // Generate 32-byte account ID from 64-byte public key using Keccak-256
            // This matches the Rust implementation: sp_io::hashing::keccak_256(&public_key)[..32]
            const accountId = keccak256(pubBytes);

            // Generate proper SS58 address
            const addr = toSS58(accountId, 42);

            account = { address: addr, publicKey: pubHex };
            privateKey = key;

            document.getElementById('importResult').innerHTML = '<div class="alert success">Account imported successfully!</div>';
            document.getElementById('importKey').value = '';
            updateAccountDisplay();
        }

        // Load the funded test account (Alice/Sudo)
        
        // Pre-generated SPHINCS+ test accounts (valid keypairs)
        const TEST_ACCOUNTS = {
            'Alice': {
                address: '5HDjAbVHMuJzezSccj6eFrEA6nKjonrFRm8h7aTiJXSHP5Qi',
                publicKey: '0xd7d0bd475417a93fa61216a1e4024f8d1a211f795e6ab111a1eef0d5e4f3f4b156e47e5c8d4185ce4a308423eb310bb3b7f26e6d504191662d2241aafaf914cd',
                secretKey: '0xe7175a541ee055e423e070eee2cfd2a9f447a820f4e61bf03180805dbc8c4a7f1ad3437c05c2da62ed342eef62e8cac285cf8134d29b49c68a9e575f3c275991d7d0bd475417a93fa61216a1e4024f8d1a211f795e6ab111a1eef0d5e4f3f4b156e47e5c8d4185ce4a308423eb310bb3b7f26e6d504191662d2241aafaf914cd'
            },
            'Bob': {
                address: '5CAgvufYLRan7pybcGWqTxsxXRAj922Qep6UJmZuVWu8Uv11',
                publicKey: '0x12f688d8905b2b67c0fe338724a5a444b61dc949e85f51f85030b9c3f41ee661eac664300e9afc55bf1515df53827d281ce2ce295e18c298e48965ff9ef3f079',
                secretKey: '0xecb2cd6074122a9feecdf3b79435435f5d98c89baf60928b02a41d288bee96e228a29ed7e81369648d5476e66d7664100b8eae2ccc06f823912ba9c71ffadce812f688d8905b2b67c0fe338724a5a444b61dc949e85f51f85030b9c3f41ee661eac664300e9afc55bf1515df53827d281ce2ce295e18c298e48965ff9ef3f079'
            },
            'Charlie': {
                address: '5CcD6kabPt2YwaZC5A9gB3zdgu26iVJnYJNFNTR7zDW6xY5d',
                publicKey: '0x8f600722cd0887fcea1f98a26e45c1449daf0243953355554ffb3cb3d6b03922d73798351f7a1357574dd4241bd8133be9718271192b9e7a070896dec7f38598',
                secretKey: '0x7aeb22dfb296c78a18e56b73e1f40e21478b4c709d86612c4166b2b712ca758bdb978babad1c9f122138391284bb5dc35d685fb3824b47061f8a17fad099a408f600722cd0887fcea1f98a26e45c1449daf0243953355554ffb3cb3d6b03922d73798351f7a1357574dd4241bd8133be9718271192b9e7a070896dec7f38598'
            }
        };
        
        function loadTestAccount(name) {
            const acct = TEST_ACCOUNTS[name];
            if (!acct) {
                console.error('Unknown test account:', name);
                return;
            }
            account = { address: acct.address, publicKey: acct.publicKey };
            privateKey = acct.secretKey;
            document.getElementById('importResult').innerHTML = '<div class="alert success">' + name + ' test account loaded!</div>';
            console.log('Loaded ' + name + ' account:', acct.address);
            updateAccountDisplay();
        }


        // Update account display
        function updateAccountDisplay() {
            if (account) {
                document.getElementById('accountSection').style.display = 'block';
                document.getElementById('noAccountSection').style.display = 'none';
                document.getElementById('accountAddr').textContent = account.address;
                document.getElementById('faucetAddr').value = account.address;
                refreshBalance();
            } else {
                document.getElementById('accountSection').style.display = 'none';
                document.getElementById('noAccountSection').style.display = 'block';
            }
        }

        // Refresh balance
        async function refreshBalance() {
            if (!account) {
                document.getElementById('balance').textContent = '0';
                return;
            }

            try {
                // Query account balance via gateway_balance RPC
                const resp = await rpc('gateway_balance', [account.address]); const result = resp.result;
                if (result) {
                    // Convert from smallest unit (18 decimals) to QMHY
                    const balanceRaw = BigInt(result);
                    const balanceQmhy = Number(balanceRaw) / 1e18;
                    document.getElementById('balance').textContent = balanceQmhy.toFixed(4);
                } else {
                    document.getElementById('balance').textContent = '0';
                }
            } catch (e) {
                console.error('Balance error:', e);
                document.getElementById('balance').textContent = '0';
            }
        }

        // Get balance button handler
        async function getBalance() {
            const btn = event.target;
            btn.innerHTML = '<span class="spinner"></span>Loading...';
            btn.disabled = true;

            await refreshBalance();

            btn.innerHTML = 'Refresh Balance';
            btn.disabled = false;
        }

        // Send tokens
        async function sendTokens() {
            const to = document.getElementById('sendTo').value.trim();
            const amount = document.getElementById('sendAmount').value;

            if (!account) {
                document.getElementById('sendResult').innerHTML = '<div class="alert error">No account loaded</div>';
                return;
            }

            if (!privateKey) {
                document.getElementById('sendResult').innerHTML = '<div class="alert error">No private key available. Please create or import an account.</div>';
                return;
            }

            if (!to || !to.startsWith('5')) {
                document.getElementById('sendResult').innerHTML = '<div class="alert error">Invalid recipient address</div>';
                return;
            }

            if (!amount || parseFloat(amount) <= 0) {
                document.getElementById('sendResult').innerHTML = '<div class="alert error">Invalid amount</div>';
                return;
            }

            const btn = event.target;
            btn.innerHTML = '<span class="spinner"></span>Processing...';
            btn.disabled = true;

            try {
                // Get nonce for sender
                const nonceResp = await rpc('gateway_nonce', [account.address]);
                if (nonceResp.error) {
                    throw new Error('Failed to get nonce: ' + (nonceResp.error.message || JSON.stringify(nonceResp.error)));
                }
                const nonce = nonceResp.result;

                // Get genesis hash
                const genesisResp = await rpc('gateway_genesisHash', []);
                if (genesisResp.error) {
                    throw new Error('Failed to get genesis hash: ' + (genesisResp.error.message || JSON.stringify(genesisResp.error)));
                }
                const genesisHash = genesisResp.result;

                // Convert amount to smallest units (18 decimals)
                const amountFloat = parseFloat(amount);
                const amountRaw = BigInt(Math.floor(amountFloat * 1e18)).toString();

                // Build transaction request with camelCase field names (must match Rust struct)
                const txRequest = {
                    from: account.address,
                    to: to,
                    amount: amountRaw,
                    nonce: nonce,
                    genesisHash: genesisHash,
                    secretKey: privateKey
                };

                console.log('Submitting transaction:', JSON.stringify(txRequest, null, 2));

                // Submit transaction via gateway_submit RPC
                const submitResp = await rpc('gateway_submit', [txRequest]);

                if (submitResp.error) {
                    const errMsg = submitResp.error.message || submitResp.error.data || JSON.stringify(submitResp.error);
                    throw new Error('Transaction failed: ' + errMsg);
                }

                const result = submitResp.result;
                if (!result) {
                    throw new Error('Transaction submission returned empty result');
                }

                // Extract transaction hash
                let txHash = 'pending';
                if (typeof result === 'object' && result.hash) {
                    txHash = result.hash;
                } else if (typeof result === 'string') {
                    txHash = result;
                }

                document.getElementById('sendResult').innerHTML = `
                    <div class="alert success">Transfer submitted successfully!</div>
                    <div class="info-row">
                        <span class="info-label">Tx Hash</span>
                        <span class="info-value" style="font-size: 10px;">${txHash.slice(0, 24)}...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">To</span>
                        <span class="info-value">${to.slice(0, 20)}...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Amount</span>
                        <span class="info-value">${amount} QMHY</span>
                    </div>
                `;

                // Refresh balance after a short delay
                setTimeout(() => refreshBalance(), 3000);

            } catch (error) {
                console.error('Transfer error:', error);
                document.getElementById('sendResult').innerHTML = `
                    <div class="alert error">Transfer failed: ${error.message || 'Unknown error'}</div>
                `;
            }

            btn.innerHTML = 'Execute Transfer';
            btn.disabled = false;
        }

        // Request faucet
        async function requestFaucet() {
            const addr = document.getElementById('faucetAddr').value.trim();

            if (!addr) {
                document.getElementById('faucetResult').innerHTML = '<div class="alert error">Enter an address</div>';
                return;
            }

            if (!addr.startsWith('5') || addr.length < 40) {
                document.getElementById('faucetResult').innerHTML = '<div class="alert error">Invalid address format. Must start with "5" and be 47+ characters.</div>';
                return;
            }

            const btn = event.target;
            btn.innerHTML = '<span class="spinner"></span>Requesting...';
            btn.disabled = true;

            try {
                // Call the actual faucet API
                const faucetRes = await fetch(FAUCET + '/drip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address: addr })
                });

                const faucetData = await faucetRes.json();

                if (!faucetRes.ok || faucetData.error) {
                    throw new Error(faucetData.error || 'Faucet request failed');
                }

                // Extract transaction hash
                let txHash = 'pending';
                if (faucetData.txHash) {
                    if (typeof faucetData.txHash === 'object' && faucetData.txHash.hash) {
                        txHash = faucetData.txHash.hash;
                    } else if (typeof faucetData.txHash === 'string') {
                        txHash = faucetData.txHash;
                    }
                }

                document.getElementById('faucetResult').innerHTML = `
                    <div class="alert success">Tokens sent successfully!</div>
                    <div class="info-row">
                        <span class="info-label">Recipient</span>
                        <span class="info-value">${addr.slice(0, 20)}...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Amount</span>
                        <span class="info-value">${faucetData.amount || '100 QMHY'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Tx Hash</span>
                        <span class="info-value" style="font-size: 11px;">${txHash.slice(0, 20)}...${txHash.slice(-8)}</span>
                    </div>
                    <div class="alert info" style="margin-top: 10px;">
                        Balance will update shortly. Click "Refresh Balance" in Wallet tab.
                    </div>
                `;

                // Refresh balance after a short delay
                if (account && account.address === addr) {
                    setTimeout(refreshBalance, 3000);
                }
            } catch (e) {
                document.getElementById('faucetResult').innerHTML =
                    `<div class="alert error">Request failed: ${e.message}</div>`;
            }

            btn.innerHTML = 'Request Tokens';
            btn.disabled = false;
        }

        // ===========================================
        // NETWORK MESH VISUALIZATION (Dynamic)
        // ===========================================

        // Dynamic peer list - populated from RPC
        let VALIDATOR_NODES = [];
        const geoCache = {}; // Cache GeoIP lookups

        // Generate consistent color from peer ID
        function peerIdToColor(peerId) {
            let hash = 0;
            for (let i = 0; i < peerId.length; i++) {
                hash = peerId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash % 360);
            return `hsl(${hue}, 70%, 60%)`;
        }

        // Extract IP from multiaddr (e.g., /ip4/51.79.26.168/tcp/30333)
        function extractIpFromAddr(addr) {
            const match = addr.match(/\/ip4\/([0-9.]+)/);
            return match ? match[1] : null;
        }

        // Fetch location from IP using free GeoIP service
        async function getLocationFromIp(ip) {
            if (!ip || ip === '127.0.0.1' || ip.startsWith('192.168.') || ip.startsWith('10.')) {
                return 'Local';
            }
            if (geoCache[ip]) return geoCache[ip];
            try {
                const resp = await fetch(`http://ip-api.com/json/${ip}?fields=city,country`);
                const data = await resp.json();
                const location = data.city ? `${data.city}, ${data.country}` : data.country || 'Unknown';
                geoCache[ip] = location;
                return location;
            } catch (e) {
                return 'Unknown';
            }
        }

        // Fetch connected peers and build dynamic node list
        async function updateNetworkPeers() {
            try {
                // Get local node info
                const [localName, localPeerId, peers] = await Promise.all([
                    rpcCall('system_name'),
                    rpcCall('system_localPeerId'),
                    rpcCall('system_peers')
                ]);

                const nodes = [];

                // Add "You" (local node) first
                nodes.push({
                    name: localName || 'You',
                    ip: 'localhost',
                    location: 'Local',
                    color: '#ffcc00',
                    isLocal: true,
                    peerId: localPeerId
                });

                // Add connected peers
                for (const peer of (peers || [])) {
                    const ip = extractIpFromAddr(peer.bestKnownAddr || '');
                    const location = await getLocationFromIp(ip);

                    // Use peer's reported name, or truncated peer ID
                    const name = peer.name || `Node ${peer.peerId.slice(-4)}`;

                    nodes.push({
                        name: name,
                        ip: ip || 'unknown',
                        location: location,
                        color: peerIdToColor(peer.peerId),
                        peerId: peer.peerId,
                        bestBlock: peer.bestNumber
                    });
                }

                VALIDATOR_NODES = nodes;

                // Update peer count display
                const peerCountEl = document.getElementById('peerCount');
                if (peerCountEl) peerCountEl.textContent = peers?.length || 0;

                // Update the validator node cards
                updateValidatorNodes();

            } catch (e) {
                console.error('Failed to fetch peers:', e);
            }
        }

        // Update peers every 10 seconds
        setInterval(updateNetworkPeers, 10000);
        updateNetworkPeers(); // Initial fetch

        function drawNetworkMesh() {
            const canvas = document.getElementById('networkCanvas');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#0a0a14';
            ctx.fillRect(0, 0, width, height);

            // Grid
            ctx.strokeStyle = 'rgba(255, 153, 102, 0.1)';
            ctx.lineWidth = 1;
            for (let y = 0; y <= height; y += 30) {
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke();
            }
            for (let x = 0; x <= width; x += 30) {
                ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
            }

            const centerX = width / 2;
            const centerY = height / 2;
            const time = Date.now() / 3000;

            const nodePositions = VALIDATOR_NODES.map((node, i) => {
                const angle = (i / VALIDATOR_NODES.length) * Math.PI * 2 + time * 0.2;
                const radius = 80 + Math.sin(time + i) * 8;
                return {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius * 0.6,
                    node: node
                };
            });

            // Connections
            ctx.lineWidth = 2;
            nodePositions.forEach((pos1, i) => {
                nodePositions.forEach((pos2, j) => {
                    if (i >= j) return;
                    const gradient = ctx.createLinearGradient(pos1.x, pos1.y, pos2.x, pos2.y);
                    gradient.addColorStop(0, pos1.node.color + '80');
                    gradient.addColorStop(1, pos2.node.color + '80');
                    ctx.strokeStyle = gradient;
                    ctx.beginPath();
                    ctx.moveTo(pos1.x, pos1.y);
                    const midX = (pos1.x + pos2.x) / 2;
                    const midY = (pos1.y + pos2.y) / 2 - 15;
                    ctx.quadraticCurveTo(midX, midY, pos2.x, pos2.y);
                    ctx.stroke();

                    // Data packet
                    const packetPos = (time * 2 + i * 0.5) % 1;
                    const px = pos1.x + (pos2.x - pos1.x) * packetPos;
                    const py = pos1.y + (pos2.y - pos1.y) * packetPos - Math.sin(packetPos * Math.PI) * 15;
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(px, py, 2, 0, Math.PI * 2);
                    ctx.fill();
                });
            });

            // Nodes
            nodePositions.forEach(pos => {
                ctx.fillStyle = pos.node.color;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 12, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#ffffff';
                ctx.font = '10px Orbitron, monospace';
                ctx.textAlign = 'center';
                ctx.fillText(pos.node.name, pos.x, pos.y + 28);
            });

            ctx.fillStyle = '#ff9966';
            ctx.font = '11px Orbitron';
            ctx.textAlign = 'left';
            ctx.fillText('NETWORK MESH', 8, 18);

            // Dynamic node count (top-right)
            ctx.fillStyle = '#66ff99';
            ctx.textAlign = 'right';
            ctx.fillText(`${VALIDATOR_NODES.length} NODES`, width - 8, 18);

            requestAnimationFrame(drawNetworkMesh);
        }

        function updateValidatorNodes() {
            const container = document.getElementById('validatorNodes');
            if (!container) return;

            container.innerHTML = VALIDATOR_NODES.map(node => `
                <div style="background: rgba(255,255,255,0.05); border-radius: 6px; padding: 10px; border-left: 3px solid ${node.color};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: ${node.color}; font-family: 'Orbitron', monospace; font-size: 12px;">${node.name}</span>
                        ${node.isLocal ? '<span style="color: #66ff99; font-size: 9px;"> LOCAL</span>' : '<span style="color: #66ff99; font-size: 9px;"></span>'}
                    </div>
                    <div style="font-size: 10px; color: #888; margin-top: 4px;"> ${node.location}</div>
                    <div style="font-size: 9px; color: #666; margin-top: 2px;"> ${node.ip}</div>
                    ${node.bestBlock ? `<div style="font-size: 9px; color: #666; margin-top: 2px;"> Block #${node.bestBlock}</div>` : ''}
                    ${node.peerId ? `<div style="font-size: 8px; color: #444; margin-top: 2px; word-break: break-all;">ID: ${node.peerId.slice(0, 20)}...</div>` : ''}
                </div>
            `).join('');
        }

        async function updateNetworkHealth() {
            const healthEl = document.getElementById('networkHealth');
            if (!healthEl) return;

            const health = (await rpc('system_health')).result;
            if (!health) {
                healthEl.textContent = 'OFFLINE';
                healthEl.style.color = 'var(--orange)';
                return;
            }

            const peerCount = health.peers || 0;
            if (peerCount >= 2 && !health.isSyncing) {
                healthEl.textContent = 'OPTIMAL';
                healthEl.style.color = 'var(--neon-green)';
            } else if (peerCount >= 1) {
                healthEl.textContent = 'DEGRADED';
                healthEl.style.color = 'var(--orange)';
            } else {
                healthEl.textContent = 'CRITICAL';
                healthEl.style.color = '#ff4444';
            }
        }

        async function updatePeerList() {
            const tbody = document.getElementById('peerList');
            const peers = (await rpc('system_peers')).result;

            if (!peers || peers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: var(--light-gray);">No peers connected</td></tr>';
                return;
            }

            tbody.innerHTML = peers.map(peer => `
                <tr>
                    <td style="font-size: 10px;">${peer.peerId ? peer.peerId.substring(0, 12) + '...' : '?'}</td>
                    <td>${peer.roles || 'Full'}</td>
                    <td>#${peer.bestNumber || '?'}</td>
                </tr>
            `).join('');
        }

        // Initialize
        updateStatus();
        updateRecentBlocks();
        updateValidatorNodes();
        updateNetworkHealth();
        updatePeerList();
        drawNetworkMesh();

        setInterval(updateStatus, 5000);
        setInterval(updateRecentBlocks, 10000);
        setInterval(updateNetworkHealth, 10000);
        setInterval(updatePeerList, 15000);
    </script>

<!-- DEBUG CONSOLE -->
<style>
#debug-console {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 180px;
    background: #0a0a0a;
    border-top: 3px solid #ff9900;
    font-family: monospace;
    font-size: 12px;
    z-index: 9999;
    display: flex;
    flex-direction: column;
}
#debug-console-header {
    background: #ff9900;
    color: black;
    padding: 5px 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: bold;
}
#debug-console-content {
    flex: 1;
    overflow-y: auto;
    padding: 8px 10px;
    color: #0f0;
    user-select: text;
    -webkit-user-select: text;
}
#debug-console-content div { margin: 3px 0; padding: 2px 0; }
#debug-console-content .error { color: #ff6666; }
#debug-console-content .warn { color: #ffff00; }
#debug-console-content .info { color: #66ccff; }
.dbg-btn {
    background: #333;
    color: white;
    border: 1px solid #666;
    padding: 3px 10px;
    cursor: pointer;
    margin-left: 5px;
}
.dbg-btn:hover { background: #555; }
</style>

<div id="debug-console">
    <div id="debug-console-header">
        <span>DEBUG CONSOLE (select all text below and copy)</span>
        <div>
            <button class="dbg-btn" onclick="document.getElementById('debug-console-content').innerHTML=''">CLEAR</button>
            <button class="dbg-btn" onclick="document.getElementById('debug-console').style.display='none'">HIDE</button><button class="dbg-btn" onclick="document.getElementById('debug-console').style.display='flex'" style="position:fixed;bottom:5px;right:5px;z-index:9998;display:none" id="show-console-btn">SHOW CONSOLE</button>
        </div>
    </div>
    <div id="debug-console-content"></div>
</div>

<script>
(function() {
    var dbgEl = document.getElementById('debug-console-content');
    
    function dbgLog(msg, type) {
        var div = document.createElement('div');
        div.className = type || '';
        var time = new Date().toLocaleTimeString();
        div.textContent = '[' + time + '] ' + msg;
        dbgEl.appendChild(div);
        dbgEl.scrollTop = dbgEl.scrollHeight;
    }
    
    var origLog = console.log;
    var origError = console.error;
    var origWarn = console.warn;
    
    console.log = function() {
        origLog.apply(console, arguments);
        var msg = Array.prototype.slice.call(arguments).map(function(a) {
            return typeof a === 'object' ? JSON.stringify(a) : String(a);
        }).join(' ');
        dbgLog(msg, 'info');
    };
    
    console.error = function() {
        origError.apply(console, arguments);
        var msg = Array.prototype.slice.call(arguments).map(function(a) {
            return typeof a === 'object' ? JSON.stringify(a) : String(a);
        }).join(' ');
        dbgLog(msg, 'error');
    };
    
    console.warn = function() {
        origWarn.apply(console, arguments);
        var msg = Array.prototype.slice.call(arguments).map(function(a) {
            return typeof a === 'object' ? JSON.stringify(a) : String(a);
        }).join(' ');
        dbgLog(msg, 'warn');
    };
    
    dbgLog('=== PAGE LOADED ===', 'info');
    dbgLog('keccak_256: ' + (typeof keccak_256), 'info');
    dbgLog('blakejs: ' + (typeof blakejs), 'info');
    if (typeof blakejs !== 'undefined' && blakejs) {
        dbgLog('blakejs.blake2b: ' + (typeof blakejs.blake2b), 'info');
    }
    dbgLog('==================', 'info');
})();
</script>

</body>
</html>
