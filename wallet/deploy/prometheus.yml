global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets: []

# Load rules once and periodically evaluate them
rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

# Scrape configurations
scrape_configs:
  # Prometheus itself
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # Quantum Tunnel Server metrics
  - job_name: 'quantum-tunnel'
    static_configs:
      - targets: ['quantum-tunnel:9090']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'quantum-tunnel-server'

  # Node exporter for system metrics (optional)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']

  # Custom metrics from wallet
  - job_name: 'quantum-wallet'
    metrics_path: '/api/metrics'
    static_configs:
      - targets: ['quantum-wallet:3030']

# Alerts configuration
groups:
  - name: quantum_alerts
    interval: 30s
    rules:
      - alert: TunnelServerDown
        expr: up{job="quantum-tunnel"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Quantum Tunnel Server is down"
          description: "The quantum tunnel server has been down for more than 1 minute."

      - alert: NoActiveTunnels
        expr: quantum_tunnel_active_connections == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "No active quantum tunnels"
          description: "No KIRQ nodes are connected via quantum tunnels."

      - alert: HighMessageRate
        expr: rate(quantum_tunnel_messages_total[5m]) > 1000
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High message rate through tunnels"
          description: "Message rate is {{ $value }} messages/second."

      - alert: LowQKDEntropy
        expr: rate(quantum_tunnel_qkd_injections_total[5m]) < 0.01
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low QKD entropy injection rate"
          description: "QKD entropy injection rate is below threshold."