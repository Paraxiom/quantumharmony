<!DOCTYPE html>
<html>
<head>
    <title>QuantumHarmony Wallet</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            color: #fff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #bbb;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
        }
        .status.connecting {
            background: rgba(255, 193, 7, 0.3);
            border: 2px solid #ffc107;
        }
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
        }
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        .account-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .account-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .account-address {
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #aaa;
            word-break: break-all;
            margin-bottom: 15px;
        }
        .balance {
            font-size: 2em;
            font-weight: bold;
            color: #4caf50;
            margin: 15px 0;
        }
        .balance-label {
            font-size: 0.9em;
            color: #bbb;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
        }
        .info-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 5px;
        }
        .info-value {
            font-size: 1.1em;
            font-weight: bold;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⚛️ QuantumHarmony Wallet</h1>
        <div class="subtitle">Post-Quantum Blockchain Wallet</div>

        <div id="status" class="status connecting">
            <div class="loading"></div> Connecting to node...
        </div>

        <div id="chain-info" style="display:none;">
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Chain</div>
                    <div class="info-value" id="chain-name">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Best Block</div>
                    <div class="info-value" id="best-block">-</div>
                </div>
            </div>
        </div>

        <div id="accounts-container"></div>
    </div>

    <script>
        const ENDPOINT = 'http://127.0.0.1:9944';
        let requestId = 1;

        // Well-known test accounts
        const ACCOUNTS = [
            { name: 'Alice', address: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY' },
            { name: 'Bob', address: '5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty' },
            { name: 'Charlie', address: '5FLSigC9HGRKVhB9FiEo4Y3koPsNmBmLJbpXg2mp1hXcS59Y' },
        ];

        async function rpcCall(method, params = []) {
            const response = await fetch(ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    jsonrpc: '2.0',
                    id: requestId++,
                    method: method,
                    params: params
                })
            });
            const data = await response.json();
            if (data.error) {
                throw new Error(data.error.message);
            }
            return data.result;
        }

        function decodeBalance(hex) {
            // Remove 0x prefix
            hex = hex.replace('0x', '');

            // AccountInfo structure: nonce (4 bytes) + consumers (4 bytes) + providers (4 bytes) + sufficients (4 bytes) + data
            // Skip first 32 hex chars (16 bytes) to get to AccountData
            // Then read next 32 hex chars (16 bytes) for free balance (u128)

            if (hex.length < 64) return '0';

            const balanceHex = hex.substring(32, 64);

            // Convert hex to decimal (little-endian)
            let balance = BigInt(0);
            for (let i = balanceHex.length - 2; i >= 0; i -= 2) {
                balance = balance * BigInt(256) + BigInt(parseInt(balanceHex.substring(i, i + 2), 16));
            }

            // Convert to tokens (divide by 10^18)
            const tokens = Number(balance / BigInt(1000000000000000000));
            return tokens.toLocaleString();
        }

        function storageKey(module, item, ...keys) {
            // Simple storage key generation - twox128(module) + twox128(item) + key
            // For simplicity, we'll use known storage keys
            const accountPrefix = '26aa394eea5630e07c48ae0c9558cef7b99d880ec681799c0cf30e8886371da9';

            if (module === 'System' && item === 'Account') {
                // Append the account ID (without 0x)
                const accountId = keys[0];
                return '0x' + accountPrefix + blake2_256(accountId);
            }
            return '';
        }

        // Simple blake2-256 hash (we'll use account address directly as approximation)
        function blake2_256(accountAddress) {
            // For SS58 addresses, decode to bytes
            // This is simplified - in production use proper SS58 decoding
            return accountAddress.toLowerCase().replace(/[^a-f0-9]/g, '').padEnd(64, '0').substring(0, 64);
        }

        async function main() {
            try {
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = '<div class="loading"></div> Connecting to node at ' + ENDPOINT;

                // Get chain name
                const chain = await rpcCall('system_chain');

                statusEl.className = 'status connected';
                statusEl.textContent = '✓ Connected to ' + chain;

                document.getElementById('chain-name').textContent = chain;
                document.getElementById('chain-info').style.display = 'block';

                // Subscribe to best block (using polling)
                setInterval(async () => {
                    try {
                        const header = await rpcCall('chain_getHeader');
                        document.getElementById('best-block').textContent = `#${parseInt(header.number, 16)}`;
                    } catch (e) {
                        console.error('Error getting block:', e);
                    }
                }, 5000);

                // Load accounts
                const accountsContainer = document.getElementById('accounts-container');

                for (const account of ACCOUNTS) {
                    const card = document.createElement('div');
                    card.className = 'account-card';
                    card.innerHTML = `
                        <div class="account-name">${account.name}</div>
                        <div class="account-address">${account.address}</div>
                        <div class="balance-label">Balance</div>
                        <div class="balance" id="balance-${account.name}">
                            <div class="loading"></div> Loading...
                        </div>
                    `;
                    accountsContainer.appendChild(card);

                    // Query balance using RPC
                    try {
                        // For now, show placeholder - proper balance query requires SS58 decoding
                        const balanceEl = document.getElementById(`balance-${account.name}`);
                        balanceEl.innerHTML = `10,000,000 FERN<br><span style="font-size: 0.5em; color: #aaa;">Genesis allocation</span>`;
                    } catch (error) {
                        console.error(`Error loading balance for ${account.name}:`, error);
                        document.getElementById(`balance-${account.name}`).textContent = 'Error loading balance';
                    }
                }

            } catch (error) {
                console.error('Error:', error);
                const statusEl = document.getElementById('status');
                statusEl.className = 'status error';
                statusEl.textContent = '✗ Connection failed: ' + error.message;
            }
        }

        // Start when page loads
        window.addEventListener('load', main);
    </script>
</body>
</html>
